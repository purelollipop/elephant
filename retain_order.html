<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../resource/iview-2.0/dist/styles/iview.css">
    <link rel="stylesheet" href="../resource/css/tableCustom.css" >
    <style rel="stylesheet">
        .ivu-tabs-bar{
            margin-bottom: 2px;
        }
        .retainTable{
            border: 1px silver solid;
        }
        .retainTable>thead>tr>th{
            border: 1px #E7E7E7 solid;
        }
        .retainTable>tbody>tr>td{
            border: 1px #E7E7E7 solid;
        }
        .allSearch{
            display: flex;
            flex-wrap:wrap;
            margin-bottom: 5px;
            /*width: 300px;*/
            /*position: absolute;*/
            /*top: -200px;*/
            /*display: none;*/
            /*visibility: hidden;*/
        }
        .allSearch>div{
            width: 200px;
            margin: 3px 3px;
        }
        .divshow{
            /*display: block;*/
            top: 1px;
            position: relative;
            visibility: visible;
            transition: top 2s,position 2s,visibility 2s;
        }
        tr[data-repeat='1']{
            background-color: #F8EFC0;
        }
        td[data-color='1']{
            background-color: red;
        }
        .remaClass:hover{
            background-color: #0e9aef;
        }
    </style>
</head>
<body>
<div id="retainOrder">
    <Tabs v-model="name"
          :animated="false"
          style="min-height: 1000px">
        <Tab-pane label="统计" name="name1">
            <all_order_table v-if="name=='name1'" :name.sync="name"></all_order_table>
        </Tab-pane>
        <Tab-pane label="详情" name="name2">
            <alone_order_table v-if="name=='name2'"></alone_order_table>
        </Tab-pane>
    </Tabs>
</div>
<!--统计组件 显示所有单，后台已将所有单分类好，形成不同政策-->
<template id="allOrderTable">
    <div>
        <div class="allSearch" v-if="searchFlag">
            <!--航变号-->
            <i-input class="chooseChild" v-model="searchObj.code">
                <span slot="prepend">航班号</span>
            </i-input>
            <!--出发-->
            <i-input class="chooseChild" v-model="searchObj.dpt">
                <span slot="prepend">出发</span>
            </i-input>
            <!--到达-->
            <i-input class="chooseChild" v-model="searchObj.arr">
                <span slot="prepend">到达</span>
            </i-input>
            <!--直享舱位-->
            <i-input class="chooseChild" v-model="searchObj.saleCabinCode">
                <span slot="prepend">直享舱位</span>
            </i-input>
            <!--航司-->
            <i-input class="chooseChild" disabled v-model="searchObj.carrier">
                <span slot="prepend">航司</span>
            </i-input>
            <Date-picker type="daterange"
                         v-model="searchObj.time"
                         placement="bottom-end"
                         placeholder="日期"
                         @on-change="flyTimeFun"
            >
            </Date-picker>
            <!--类型-->
            <i-input class="chooseChild" v-model="searchObj.type">
                <span slot="prepend">类型</span>
            </i-input>
            <i-select v-model="searchObj.ticketTable" placeholder="平台选择">
                <i-option value="携程">携程</i-option>
                <i-option value="携程分销">携程分销</i-option>
                <i-option value="同程">同程</i-option>
                <i-option value="去哪儿">去哪儿</i-option>
                <i-option value="平安淘宝">平安淘宝</i-option>
            </i-select>
            <div>
                <i-button type="success" size="small" @click="sureSearch">开始搜索</i-button>
            </div>
        </div>
        <i-button type="primary" icon="ios-search" size="small" @click="allSearchFun">搜索</i-button>
        <i-button type="primary" size="small" @click="allOrder">批量出票</i-button>
        <i-button type="primary" size="small" @click="allExportFun">导出</i-button>
        <table class="retainTable" style="font-size: 12px;width: 100%">
            <colgroup>
                <col style="width:50px"><!--全选-->
                <col style="width:auto"><!--平台-->
                <col style="width:auto"><!--订单号-->
                <col style="width:auto"><!--进单时长-->
                <col style="width:auto"><!--平台状态-->
                <col style="width:auto"><!--备注-->
            </colgroup>
            <thead >
            <tr style="text-align:center;height: 40px" class="headBorder">
                <th>
                    <input type="checkbox" @click="allInput" id="retain_all_input">
                    <span>全选</span>
                </th>
                <th>航班号</th>
                <th style="text-align:center">航班日期</th>
                <th>起飞时间</th>
                <th>出发</th>
                <th>到达</th>
                <th>已收</th>
                <th>直享</th>
                <th>经济</th>
                <th style="text-align:center">更新时间</th>
                <th>类型</th>
                <th style="padding: 1px">
                    <span>操作</span>
                </th>
            </tr>
            </thead>
            <tbody class="" >
            <tr v-for="(ord,index) in allOrderObj" :key="ord.index" style="height: 60px">
                <td>
                    <input type="checkbox" class="inputClick" @click="aloneInput(ord.code,ord.date,ord.dpt,ord.arr,ord.id)">{{index+1+(20*(num - 1))}}
                </td>
                <!--航班号-->
                <td>
                    <div v-if="ord.seatsForSale - ord.number <=3" style="color: red">{{ord.code}}</div>
                    <div v-else>{{ord.code}}</div>
                </td>
                <!--航班日期-->
                <td>
                    <div>{{ord.date}}</div>
                </td>
                <!--起飞时间-->
                <td>
                    <div>{{ord.dpttime}}</div>
                </td>
                <!--出发-->
                <td>
                    <div>{{ord.dpt}}</div>
                </td>
                <!--到达-->
                <td>
                    <div>{{ord.arr}}</div>
                </td>
                <!--已收-->
                <td>
                    <div>{{ord.number}}</div>
                </td>
                <!--直享-->
                <td>
                    <span title="余位">{{ord.seatsForSale}}</span>
                    <span title="舱位">/{{ord.saleCabinCode}}</span>
                    <span title="价格">/{{ord.printPrice}}</span>
                </td>

                <!--经济-->
                <td>
                    <span title="经济余位">{{ord.seatsForJinji}}</span>
                    <span title="经济舱位">/{{ord.jinjiCabinCode}}</span>
                    <span title="经济价格">/{{ord.jinjiPrice}}</span>
                </td>
                <!--更新时间-->
                <td>
                    <div>{{ord.lasttime}}</div>
                </td>
                <!--类型-->
                <td>
                    <div>{{ord.type}}</div>
                </td>
                <!--处理按钮-->
                <td>
                    <button class="butt"  @click="checkOrder(ord.id)">出票</button>
                    <button class="butt"  @click="detailed(ord.code,ord.date,ord.dpt,ord.arr,ord.carrier)">详情</button>
                </td>
            </tr>
            </tbody>
        </table>
        <!--分页逻辑-->
        <div style="float: right;margin-top: 20px">
            <span>总计{{count}}条</span>
            <button type="button"  class=""  @click="firstpage">第一页</button>
            <button type="button"  class=""  @click="uppage">前一页</button>
            共<span>{{pages}}</span>页&nbsp;&nbsp;
            第&nbsp;<input type="text" style="width:40px;height:22px;padding:5px;display: inline;font-size: .9em;" :value="num" ref="num">&nbsp;页&nbsp;&nbsp;
            <button  class=""  @click="gotopage">转到</button>
            <button  class=""  @click="downpage">后一页</button>
            <button  class=""  @click="llastpage">最后一页</button>
        </div>
    </div>
</template>

<template id="aloneOrderTable">
    <div>
        <div class="allSearch" v-if="searchAloneFlag">
            <!--航班号-->
            <i-input class="chooseChild" v-model="searchObj.code">
                <span slot="prepend">航班号</span>
            </i-input>
            <!--出发-->
            <i-input class="chooseChild" v-model="searchObj.dpt">
                <span slot="prepend">出发</span>
            </i-input>
            <!--到达-->
            <i-input class="chooseChild" v-model="searchObj.arr">
                <span slot="prepend">到达</span>
            </i-input>
            <!--航班号-->
            <i-input class="chooseChild" v-model="searchObj.orderNo">
                <span slot="prepend">平台订单号</span>
            </i-input>
            <!--小编-->
            <i-input class="chooseChild" v-model="searchObj.pnr">
                <span slot="prepend">小编</span>
            </i-input>
            <!--直享舱位-->
            <i-input class="chooseChild" v-model="searchObj.saleCabinCode">
                <span slot="prepend">直享舱位</span>
            </i-input>
            <!--乘机人-->
            <i-input class="chooseChild" v-model="searchObj.passengerinfo">
                <span slot="prepend">乘机人</span>
            </i-input>
            <!--航司-->
            <i-input class="chooseChild" disabled v-model="searchObj.carrier">
                <span slot="prepend">航司</span>
            </i-input>
            <!--platformstatus-->
            <i-select v-model="searchObj.platformstatus" placeholder="平台状态">
                <i-option value="支付成功等待出票">支付成功等待出票</i-option>
                <i-option value="出票完成">出票完成</i-option>
                <i-option value="改期申请中">改期申请中</i-option>
                <i-option value="未出票申请退款">未出票申请退款</i-option>
            </i-select>
            <Date-picker type="daterange"
                         v-model="searchObj.time"
                         placement="bottom-end"
                         placeholder="日期"
                         @on-change="flyTimeFun"
            >
            </Date-picker>
            <!--类型-->
            <i-input class="chooseChild" v-model="searchObj.type">
                <span slot="prepend">类型</span>
            </i-input>
            <!--进单平台-->
            <!--style="margin-top: 5px;height: 32px;border-color:rgb(220, 222, 226);border-radius: 4px"-->
            <i-select v-model="searchObj.ticketTable" placeholder="平台选择">
                <i-option value="携程">携程</i-option>
                <i-option value="携程分销">携程分销</i-option>
                <i-option value="同程">同程</i-option>
                <i-option value="去哪儿">去哪儿</i-option>
                <i-option value="平安淘宝">平安淘宝</i-option>
                <i-option value="携程分销">携程分销</i-option>
            </i-select>
            <div>
                <i-button type="primary" size="small" @click="sureAloneSearch">开始搜索</i-button>
            </div>
        </div>
        <Modal
                v-model="remarkObj.remarkFlag"
                draggable scrollable
                :closable="false"
                title="备注填写"
                @on-ok="aloneRemakSureFun"
        >
            <div>
                <i-input type="textarea" v-model="remarkObj.remarkText"/>
            </div>
        </Modal>
<!--        查看日志弹窗-->
        <Modal
                v-model="lookFlag"
                title="添加日志"
                draggable
                width="500"
                :footer-hide="true"
                :z-index="2"
        >
            <table class="retainTable" style="width: 100%;table-layout: fixed;word-break: break-all;">
                <thead>
                <tr class="TableHead">
                    <th style="width: 40px">序号</th>
                    <th>入座率</th>
                    <th>时间</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(ele,index) in lookjournalObj" :key="index">
                    <!--序号-->
                    <td>{{(20 * (num - 1)) + index + 1}}</td>
                    <!--入座率-->
                    <td>{{ele.bookingrate}}</td>
                    <!--时间-->
                    <td>{{ele.time}}</td>
                </tr>
                </tbody>
            </table>
        </Modal>

        <i-button type="primary" icon="ios-search" size="small" @click="aloneSearch">搜索</i-button>
        <i-button type="primary" size="small" @click="alontLotSize">批量出票</i-button>
        <i-button type="success" size="small" @click="findBtn" v-if="isShow">批量查询</i-button>
        <i-button type="primary" size="small" @click="exportFun">导出</i-button>
        <table class="retainTable" style="font-size: 12px;width: 100%">
            <colgroup>
                <col style="width:auto"><!--全选-->
                <col style="width:auto"><!--航班号-->
                <col style="width:70px"><!--进单日期-->
                <col style="width:75px"><!--最晚出票时限-->
                <col style="width:70px"><!--航班日期-->
                <col style="width:auto"><!--小编/订单号	-->
                <col style="width:70px"><!--平台状态-->
                <col style="width:auto"><!--乘机人-->
                <col style="width:auto"><!--收款金额-->
                <col style="width:auto"><!--进单-->
                <col style="width:auto"><!--直享-->
                <col style="width:auto"><!--经济-->
                <col style="width:auto"><!--更新时间	-->
                <col style="width:auto"><!--回帖结果	-->
                <col style="width:auto"><!--类型-->
                <col style="width:auto"><!--备注-->
                <col style="width:auto"><!--操作-->
            </colgroup>
            <thead >
            <tr style="text-align:center;height: 40px" class="headBorder">
                <th>
                    <input type="checkbox" @click="alontAllInput" class="aloneLotSize" id="retain_alone_input">
                    <span>全选</span>
                </th>
                <th>
                    <div>
                        <span>航班号</span>
                    </div>
                </th>
                <th style="text-align:center">进单日期</th>
                <th style="text-align:center">出票时限</th>
                <th style="text-align:center">航班日期</th>
                <!--<th>起飞时间</th>-->
                <th>小编/订单号</th>
                <!--<th>小编</th>-->
                <th>平台状态</th>
                <!--<th>出发</th>-->
                <!--<th>到达</th>-->
                <th>乘机人</th>
                <th>收款金额</th>
                <th>进单</th>
                <th>直享</th>
                <th>经济</th>
                <th>更新时间</th>
                <th>回帖结果</th>
                <th>类型</th>
                <th>备注</th>
                <th style="padding: 1px">
                    <span>操作</span>
                </th>
            </tr>
            </thead>
            <tbody class="" >
            <tr v-for="(ord,index) in allOrderObj" :key="index" style="height: 60px" :data-repeat="ord.is_repeat+''">
                <td>
                    <input type="checkbox" class="aloneInput" @click="detailsAloneInput(ord.id,ord.code,ord.date,ord.dpt,ord.arr)">{{index+1+(20*(num-1))}}
                </td>
                <!--航班号-->
                <td>
                    <!--经济和直享谁小 谁有优先比较权 如果有一个为0，则为0的不判断，用另一个来判断-->
                    <!--经济价小的时候 经济价优先-->
                    <div v-if="(ord.printPrice*1)>(ord.jinjiPrice*1)||((ord.jinjiPrice*1)==0)">
                        <div v-if="ord.jinjiPrice-ord.Price>30&&ord.jinjiPrice!=0" style="background-color: red">{{ord.code}}</div>
                        <div v-else-if="ord.Price - ord.jinjiPrice>20&&ord.jinjiPrice!=0" style="background-color: skyblue">{{ord.code}}</div>
                        <!--当Price和jinjiPrice相比 在20内 不显示任何颜色-->
                        <div v-else-if="ord.jinjiPrice!=0">{{ord.code}}</div>
                        <!--如果经济价为0 则 使用直享价来判断-->
                        <div v-else-if="ord.printPrice-ord.Price>30" style="background-color: red">{{ord.code}}</div>
                        <div v-else-if="ord.Price - ord.printPrice>20" style="background-color: skyblue">{{ord.code}}</div>
                        <!--当直享判断下没有超过20，则普通显示-->
                        <div v-else>{{ord.code}}</div>
                    </div>
                    <!--直享价小的时候 直享价优先-->
                    <div v-else-if="(ord.printPrice*1)<(ord.jinjiPrice*1)||((ord.printPrice*1)==0)">
                        <div v-if="ord.printPrice - ord.Price>30&&ord.printPrice!=0" style="background-color: red">{{ord.code}}</div>
                        <div v-else-if="ord.Price - ord.printPrice>20&&ord.printPrice!=0" style="background-color: skyblue">{{ord.code}}</div>
                        <!--当Price和printPrice相比 在20内 不显示任何颜色-->
                        <div v-else-if="ord.printPrice!=0">{{ord.code}}</div>
                        <!--当直享价为0的时候 则不判断 使用经济价来判断-->
                        <div v-else-if="ord.jinjiPrice-ord.Price>30" style="background-color: red">{{ord.code}}</div>
                        <div v-else-if="ord.Price - ord.jinjiPrice>20" style="background-color: skyblue">{{ord.code}}</div>
                        <!--当经济判断下没有超过20 普通显示-->
                        <div v-else>{{ord.code}}</div>
                    </div>
                    <!--两者相等的时候-->
                    <div v-else-if="ord.printPrice*1 === ord.jinjiPrice*1&&((ord.jinjiPrice*1)!=0)">
                        <div v-if="ord.jinjiPrice-ord.Price>30" style="background-color: red">{{ord.code}}</div>
                        <div v-else-if="ord.Price - ord.jinjiPrice>20" style="background-color: skyblue">{{ord.code}}</div>
                        <div v-else>{{ord.code}}</div>
                    </div>
                    <div v-else>
                        {{ord.code}}
                    </div>
                    <div>
                        <!--出发-到达-->
                        <div>{{ord.dpt}}-{{ord.arr}}</div>
                    </div>
                </td>
                <!--进单时间  | orderTimeFilter-->
                <td>
                    <div>{{ord.orderTime}}</div>
                </td>
                <!--最晚出票时限-->
                <td>
                    <div>{{ord.deadline}}</div>
                </td>
                <!--航班日期--><!--起飞时间--><!-- 实际起飞时间-->
                <td :data-color="ord.colour+''">
                    <div>{{ord.date}}</div>

                    <div v-if="ord.dpttime!=ord.reality_dptTime" style="color: red">
                        <span>{{ord.dpttime}}</span>
                        <span >{{ord.reality_dptTime}}</span>
                    </div>

                    <div v-else>
                        <span>{{ord.dpttime}}</span>
                        <span >{{ord.reality_dptTime}}</span>
                    </div>
                </td>
                <!--订单号--><!--小编-->
                <td>
                    <div>{{ord.pnr}}</div>
                    <div>{{ord.orderNo}}</div>
                </td>
                <!--平台状态-->
                <td>
                    <div v-if="ord.platformstatus=='改期申请中'||ord.platformstatus=='未出票申请退款'" style="color: red">{{ord.platformstatus}}</div>
                    <div v-else>{{ord.platformstatus}}</div>
                    <div>{{ord.channel}}</div>
                </td>
                <!--乘机人-->
                <td>
                    <div v-if="ord.passengerinfo.typeof">
                        <span>{{ord.passengerinfo.man}}</span>
                        <span>{{ord.passengerinfo.type}}</span>
                        <span>{{ord.passengerinfo.licenseNumber}}</span>
                    </div>
                    <div v-else>
                        <div v-for="(orde,index) in ord.passengerinfo" :key="index">
                            <span>{{orde.man}}</span>
                            <span>{{orde.type}}</span>
                            <span>{{orde.licenseNumber}}</span>
                        </div>
                    </div>
                </td>
                <!--收款金额-->
                <td>
                    <div>{{ord.amount}}</div>
                </td>
                <!--进单舱位-->
                <td>
                    <div>{{ord.cabin}}/{{ord.Price}}</div>
                </td>
                <!--直享-->
                <td>
                    <span title="直享余位">{{ord.seatsForSale}}</span>
                    <span title="直享舱位">/{{ord.saleCabinCode}}</span>
                    <span title="直享价格">/{{ord.printPrice}}</span>
                </td>
                <!--经济-->
                <td>
                    <span title="经济余位">{{ord.seatsForJinji}}</span>
                    <span title="经济舱位">/{{ord.jinjiCabinCode}}</span>
                    <span title="经济价格">/{{ord.jinjiPrice}}</span>
                </td>
                <!--更新时间-->
                <td>
                    <div>{{ord.lasttime}}</div>
                    <div>{{ord.reservation_state | reservation_state}}</div>
                </td>
                <!--回帖结果-->
                <td>
                    <div>{{ord.repaly_status}}</div>
                    <div>{{ord.repaly_no}}</div>
                    <button class="butt" @click="lookBtn(ord,index)" v-if="isShow">查看日志</button>
                </td>
                <!--类型-->
                <td>
                    <div>{{ord.type}}</div>
                </td>
                <!--备注-->
                <td @click="aloneRemakFun(ord.id,ord.remark)" title="点击填写备注" class="remaClass">
                    <div>{{ord.remark}}</div>
                </td>
                <!--处理按钮-->
                <td>
                    <button class="butt"  @click="aloneCheckOrder(ord.id)">出票</button>
                    <button class="butt"  @click="lookCheckBtn(ord)" v-if="isShow">查询</button>
                    <!--<button class="butt"
                            v-if="ord.platformstatus==='改期申请中'||ord.platformstatus==='未出票申请退款'||ord.platformstatus==='退款完成'||ord.platformstatus==='已取消'||ord.ticketTable==='淘宝'"
                            @click="deleteOrder(ord.id)"
                    >删除</button>-->
                    <button class="butt" @click="deleteOrder(ord.id)">删除</button>
                </td>
            </tr>
            </tbody>
        </table>
        <!--分页逻辑-->
        <div style="float: right;margin-top: 20px">
            <span>总计{{count}}条</span>
            <button type="button"  class=""  @click="firstpage">第一页</button>
            <button type="button"  class=""  @click="uppage">前一页</button>
            共<span>{{pages}}</span>页&nbsp;&nbsp;
            第&nbsp;<input type="text" style="width:40px;height:22px;padding:5px;display: inline;font-size: .9em;" :value="num" ref="num">&nbsp;页&nbsp;&nbsp;
            <button  class=""  @click="gotopage">转到</button>
            <button  class=""  @click="downpage">后一页</button>
            <button  class=""  @click="llastpage">最后一页</button>
        </div>
    </div>
</template>

<template id="changePage"></template>
<template id="search"></template>

<script src="../vue/vue.js"></script>
<script src="../resource/iview-2.0/dist/iview.js"></script>
<script src="../vue/axios.min.js"></script>
<script src="../vue/vuex.js"></script>
<script type="text/javascript">
    let urlAir = location.href.split('?air=')[1];
    const busData = Vue.observable({
        detailedObj:{
            code:null,date:null,dpt:null,arr:null,detailedFlag:null,carrier:null
        },
        carrier:urlAir?urlAir:'',
        rememberObj:{
            all:{
                num:undefined,
                searchFlag:undefined,
                searchObj:{
                    dpt:null,
                    arr:null,
                    starttime:null,
                    endtime:null,
                    code:null,
                    pages:undefined,
                    platformstatus:undefined,
                    saleCabinCode:undefined,
                    carrier:undefined,
                },
            },
            alone:{
                num:undefined,
                searchAloneFlag:undefined,
                searchObj:{
                    dpt:null,
                    arr:null,
                    starttime:null,
                    endtime:null,
                    code:null,
                    pages:undefined,
                    platformstatus:undefined,
                    saleCabinCode:undefined,
                    carrier:undefined,
                    passengerinfo:undefined,
                },
            },
        },
    })
    Vue.component('all_order_table',{
        template:'#allOrderTable',
        data(){
            return{
                allOrderObj:null,
                //第几页
                num:1,
                //共多少页
                pages:1,
                count:undefined,
                //搜索开关
                searchFlag:false,
                //搜索对象
                searchObj:{
                    dpt:null,
                    arr:null,
                    starttime:null,
                    endtime:null,
                    code:null,
                    pages:undefined,
                    platformstatus:undefined,
                    saleCabinCode:undefined,
                    carrier:undefined,
                },
                inputObject:[],
            }
        },
        computed:{
        },
        watch:{

        },
        props:['name'],
        methods:{
            //初始化函数
            objDataFun(pages = this.num,search = this.searchObj){
                search = JSON.parse(JSON.stringify(search));
                search.pages = pages;
                axios({
                    url:'../bingo/retain_order.php?action=statistics',
                    method:'post',
                    data:search,
                }).then(res=>{
                    this.num = res.data.pages*1;
                    this.pages = res.data.max_page;
                    //开始解析数据
                    this.allOrderObj = res.data.data;
                    let leng = this.allOrderObj.length;
                    //前端自己构造一个id，方便后面input按钮操作
                    for(let a=0;a<leng;a++){
                        this.allOrderObj[a].id = a;
                    }
                    this.count = res.data.count;
                }).catch(err=>{
                    console.log(err)
                })
            },
            //统计页面搜索框开启关闭功能
            allSearchFun(){
                this.searchFlag = !this.searchFlag
            },
            //搜索日期格式更改方法
            flyTimeFun(data){
                this.searchObj.starttime = data[0];
                this.searchObj.endtime = data[1];
            },
            //确定搜索
            sureSearch(){
                this.objDataFun(1,this.searchObj);
            },
            //导出功能
            allExportFun(){
                axios({
                    url:"../bingo/retain_order.php?action=statistics_out",
                    method:'post',
                    responseType: 'blob',
                    data:this.searchObj
                }).then(response=>{
                    if(response.data.size>0){
                        let filename = 'AQ留单统计';
                        let url = window.URL.createObjectURL(response.data);
                        let link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.setAttribute('download', filename + '.xls');
                        document.body.appendChild(link);
                        link.click();
                    }else{
                        alert('暂无数据');
                    }
                }).catch(err=>{
                    console.log(err);
                });
            },
            //批量确定按钮
            allOrder(){
                if(confirm('是否确定出票')){
                    if(this.inputObject.length){
                        axios({
                            url:'../bingo/retain_order.php?action=statistics_deal',
                            method:"post",
                            data:this.inputObject
                        }).then(res=>{
                            if(res.data.code == 100){
                                this.$Message.info({
                                        content:'出票操作完成',
                                        duration:10,
                                        closable:true
                                })
                                this.objDataFun()
                            }else{
                                this.$Message.info({
                                    content:'出票操作失败',
                                    duration:10,
                                    closable:true
                                })
                            }
                        }).catch(err=>{
                            console.log(err)
                        })
                    }else{
                        alert('请至少选一条政策')
                    }
                }
            },
            //统计页面单独出票按钮
            checkOrder(id){
                if(confirm('是否确定出票')){
                    let obj = [];
                    for(let a=0;a<this.allOrderObj.length;a++){
                        if(this.allOrderObj[a].id == id){
                            obj.push(this.allOrderObj[a]);
                        }
                    };
                    axios({
                        url:'../bingo/retain_order.php?action=statistics_deal',
                        method:"post",
                        data:obj
                    }).then(res=>{
                        if(res.data.code == 100){
                            this.$Message.info({
                                content:'出票操作完成',
                                duration:10,
                                closable:true
                            })
                            this.objDataFun()
                        }else{
                            this.$Message.info({
                                content:'出票操作失败',
                                duration:10,
                                closable:true
                            })
                        }
                    }).catch(err=>{
                        console.log(err)
                    })
                }
            },
            //全选按钮
            allInput(){
                let all_input = document.getElementsByClassName('inputClick');
                let leng = all_input.length;
                //防止勾选单个Input时，造成数据重复
                this.inputObject = [];
                //全选按钮是否被勾选判断，触发添加子元素
                if(event.target.checked){
                    for(let a=0;a<leng;a++){
                        all_input[a].checked = true;
                        this.inputObject.push({
                            code:this.allOrderObj[a].code,
                            date:this.allOrderObj[a].date,
                            dpt:this.allOrderObj[a].dpt,
                            arr:this.allOrderObj[a].arr,
                            id:this.allOrderObj[a].id,
                        })
                    }
                }else{
                    for(let a=0;a<leng;a++){
                        all_input[a].checked = false;
                    }
                    this.inputObject = [];
                }
            },
            //单独input按钮
            aloneInput(code,date,dpt,arr,id){
                let all_input = document.getElementById('retain_all_input');
                //此处直接传入，不使用for循环来保证数据正确对应性，前提在于删除的时候，保证删除正确性
                if(event.target.checked){
                    this.inputObject.push({
                        code,date,dpt,arr,id
                    });
                    //判断单独点击input按钮后，是否触发全选按钮
                    if(this.inputObject.length==this.allOrderObj.length){
                        all_input.checked = true;
                    }
                }else{
                    for(let a=0;a<this.inputObject.length;a++){
                        if(this.inputObject[a].id == id){
                            this.inputObject.splice(a,1);
                        }
                    };
                    //全选置为false
                    all_input.checked = false;
                };
            },
            //跳转明细页面按钮
            detailed(code,date,dpt,arr,carrier){
                let detailedFlag = true;
                busData.detailedObj = {
                    code,date,dpt,arr,detailedFlag,carrier
                };
                this.$emit('update:name','name2');
            },
            //分页函数
            //向后转页面 —
            uppage:function(){
                if(this.num>1){
                    this.num -= 1;
                }else if(this.num<1){
                    alert('没有该页码')
                }else{
                    return
                }
                this.axfun(this.num);
            },
            //向前转页面 +
            downpage:function(){
                this.num = Number(this.num); //之前的显示数字其本质为字符串导致无法数字计算
                if(this.num<this.pages){
                    this.num = this.num + 1;
                }else{
                    return
                };
                this.axfun(this.num)
            },
            //直接去某页面
            gotopage:function () {
                let val = this.$refs.num.value;
                if(val > this.pages||val<1){
                    //页数框页码重置
                    this.$refs.num.value = this.num;
                    alert('没有该页码');
                }else{
                    this.num = Math.round(this.num);
                    this.num = val;
                    this.axfun(this.num)
                }
            },
            //直接去首页
            firstpage:function () {
                //如果num已经是第一页了，就不再请求了
                if(this.num == 1){
                    return
                }
                this.num = 1;
                this.axfun(this.num)
            },
            //直接去末尾页
            llastpage:function () {
                //如果已经等于最后已页，就不再请求
                if(this.num == this.pages){
                    return
                }
                this.num = this.pages;
                this.axfun(this.num)
            },
            //跳转后把页面值传入，用来获取要跳转页面的数据，此函数为上面所有跳转函数的通用操作
            axfun:function(page){
                this.objDataFun(page)
            },
        },
        created(){
            this.num = busData.rememberObj.all.num?busData.rememberObj.all.num:1;
            this.searchFlag  = busData.rememberObj.all.searchFlag;
            this.searchObj  = busData.rememberObj.all.searchObj;
            this.searchObj.carrier = busData.carrier;
            this.objDataFun()
        },
        beforeDestroy() {
            busData.rememberObj.all.num = this.num;
            busData.rememberObj.all.searchFlag = this.searchFlag;
            busData.rememberObj.all.searchObj = this.searchObj;
        }
    });

    Vue.component('alone_order_table',{
        template:'#aloneOrderTable',
        data(){
            return{
                //table数据载体
                allOrderObj:null,
                //日志
                lookjournalObj:null,
                num:1,
                pages:undefined,
                count:undefined,
                //全选按钮出票需要传给后台的数组
                aloneInputCheckedArray:[],
                //搜索开关
                searchAloneFlag:false,
                //搜索对象
                searchObj : {
                    dpt:null,
                    arr:null,
                    starttime:null,
                    endtime:null,
                    code:null,
                    pnr:null,
                    orderNo:null,
                    pages:'',
                    platformstatus:'',
                    saleCabinCode:'',
                    ticketTable:null,
                    carrier:undefined,
                    type:'',
                    passengerinfo:undefined,
                },
                //    备注对象
                remarkObj:{
                    remarkFlag:false,
                    remarkText:'',
                    id:undefined,
                },
                lookFlag:false,
                isShow:true
            }
        },
        computed:{
            // searchObj.carrier
        },
        watch:{

        },
        filters:{
            orderTimeFilter(data){
                let a = data.split(' ');
                return a[0]
            },
            reservation_state(data){
                if(data){
                    try{
                        if(typeof JSON.parse(data) == 'object'){
                            let a = JSON.parse(data);
                            a = a.order_state.slice(0,29)
                            return a
                        }
                    }catch(e){
                        return data
                    }
                }else{
                    return ''
                }
            }
        },
        methods:{
            //数据初始化函数
            dataFun(pages = this.num,searchAlone = this.searchObj){
                let search = window.location.search;
                search = search.substring(5, search.length);
                //判断是哪个页面
                if (search=="9C" || search=="AQ"){
                    this.isShow = false;
                }
                searchAlone = JSON.parse(JSON.stringify(searchAlone));
                searchAlone.pages = pages;
                axios({
                    url:'../bingo/retain_order.php?action=details',
                    method:"post",
                    data:searchAlone,
                }).then(res=>{
                    let leng = res.data.data.length;
                    for(let a=0;a<leng;a++){
                        res.data.data[a].passengerinfo = JSON.parse(res.data.data[a].passengerinfo);
                        if(res.data.data[a].passengerinfo instanceof Array){
                            res.data.data[a].passengerinfo.typeof = 0;
                        }else{
                            res.data.data[a].passengerinfo.typeof = 1;
                        }
                    }
                    this.allOrderObj = res.data.data;
                    //最大页数
                    this.pages= res.data.max_page;
                    //当前页数
                    this.num = res.data.pages*1;
                    this.count = res.data.count;
                }).catch(err=>{
                    console.log(err)
                })
            },
            //搜索开关函数
            aloneSearch(){
                this.searchAloneFlag = !this.searchAloneFlag
            },
            //查看日志开关
            lookBtn(ord){
                this.lookFlag = ! this.lookFlag;
                let dpt = ord.dpt;
                let arr = ord.arr;
                let date = ord.date;
                let code = ord.code;
                axios({
                    url:'../bingo/retain_order.php?action=attendance_log',
                    method:"post",
                    data:{dpt,arr,date,code},
                }).then(res=>{
                    this.lookjournalObj = res.data;
                   console.log(res)
                }).catch(err=>{
                    console.log(err)
                })

            },
            //日期格式修改函数
            flyTimeFun(data){
                this.searchObj.starttime = data[0];
                this.searchObj.endtime = data[1];
            },
            //批量查询
            findBtn(){
                if (!this.aloneInputCheckedArray.length){
                    alert('请至少选择一条进行查询');
                    return
                }
                axios({
                    url:'../bingo/retain_order.php?action=attendance',
                    method:"post",
                    data:this.aloneInputCheckedArray,
                }).then(res=>{
                    if(res.status == 200){
                        this.$Message.success('查询操作完成');
                        this.dataFun()
                    }else{
                        this.$Message.warning({
                            content:'业务操作失败',
                            duration:45,
                            closable: true
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //单独查询
            lookCheckBtn(ord){
                let code = ord.code;
                let date = ord.date;
                let dpt = ord.dpt;
                let arr = ord.arr;
                axios({
                    url:'../bingo/retain_order.php?action=attendance',
                    method:"post",
                    data: [{code,date,dpt,arr}],
                }).then(res=>{
                    if(res.status == 200){
                        this.$Message.success('查询操作完成');
                        this.dataFun()
                    }else{
                        this.$Message.warning({
                            content:'业务操作失败',
                            duration:45,
                            closable: true
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //确定搜索函数
            sureAloneSearch(){
                this.num = 1;
                this.dataFun()
            },
            //导出功能
            exportFun(){
                axios({
                    url:"../bingo/retain_order.php?action=out",
                    method:'post',
                    responseType: 'blob',
                    data:this.searchObj
                }).then(response=>{
                    if(response.data.size>0){
                        let filename = 'AQ留单详情';
                        let url = window.URL.createObjectURL(response.data);
                        let link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        link.setAttribute('download', filename + '.xls');
                        document.body.appendChild(link);
                        link.click();
                    }else{
                        alert('暂无数据');
                    }
                }).catch(err=>{
                    console.log(err);
                });
            },
            //单独出票按钮
            aloneCheckOrder(id){
                let aloneArray = [];
                aloneArray.push(id);
                let flag = window.confirm('确定是否出票？');
                if(flag){
                    axios({
                        url:'../bingo/retain_order.php?action=details_deal',
                        method:"post",
                        data:aloneArray
                    }).then(res=>{
                        if(res.data.code == 100){
                            this.$Message.success({
                                content:'出票操作完成',
                                duration:10,
                                closable: true,
                            });
                            this.dataFun()
                        }else{
                            this.$Message.error({
                                content:res.data.msg,
                                duration:10,
                                closable: true,
                            })
                        }
                    }).catch(err=>{
                        console.log(err)
                    })
                }
            },
            //删除按钮
            deleteOrder(id){
                let flag = window.confirm('确定是否删除？');
                if(flag){
                    axios({
                        url:'../bingo/retain_order.php?action=details_del',
                        method:"post",
                        data:{id}
                    }).then(res=>{
                        if(res.data.code == 100){
                            this.$Message.success({
                                content:'删除完成',
                                duration:10,
                                closable: true,
                            });
                            this.dataFun()
                        }else{
                            this.$Message.error({
                                content:res.data.msg,
                                duration:10,
                                closable: true,
                            })
                        }
                    }).catch(err=>{
                        console.log(err)
                    })
                }
            },
            //全选按钮
            alontAllInput(event){
                let allAloneInput = document.getElementsByClassName('aloneInput');
                let leng = allAloneInput.length;
                //此处重置为空，在于单独input勾选后，已经加入数组，再勾选会造成数据重复
                this.aloneInputCheckedArray = [];
                if(event.target.checked){
                    for(let a=0;a<leng;a++){
                        allAloneInput[a].checked = true;
                        //此出正确做法应用Input的data-id,而不是用数据内的id
                        this.aloneInputCheckedArray.push(this.allOrderObj[a].id);
                    }
                }else{
                    for(let a=0;a<leng;a++){
                        allAloneInput[a].checked = false;
                    }
                    this.aloneInputCheckedArray = [];
                }
            },
            //批量出票
            alontLotSize(){
                if(!this.aloneInputCheckedArray.length){
                    alert('请至少选择一条出票');
                    return
                }
                let arry = [];
                for (let i = 0; i < this.aloneInputCheckedArray.length ; i++) {
                    let id=this.aloneInputCheckedArray[i].id
                    arry.push(id)
                }
                axios({
                    url:'../bingo/retain_order.php?action=details_deal',
                    method:'post',
                    data:arry,
                }).then(res=>{
                    if(res.data.code == 100){
                        this.$Message.success({
                            content:'出票操作完成',
                            duration:10,
                            closable: true,
                        });
                        this.dataFun()
                    }else{
                        this.$Message.error({
                            content:res.data.msg,
                            duration:10,
                            closable: true,
                        })
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //单独input
            detailsAloneInput(id,code,date,dpt,arr){
                let leng = this.aloneInputCheckedArray.length;
                //获取全选按钮
                let retain_alone_input = document.getElementById('retain_alone_input');
                if(event.target.checked){
                    this.aloneInputCheckedArray.push({
                        id,dpt,arr,date,code
                    });
                    //当选定的input数量与当前页面单的数量一致时候，改变全选的勾选状态
                    if(this.aloneInputCheckedArray.length == this.allOrderObj.length){
                        retain_alone_input.checked = true;
                    }
                }else{
                    for(let a=0;a<leng;a++){
                        if(this.aloneInputCheckedArray[a].id == id){
                            this.aloneInputCheckedArray.splice(a,1);
                            break
                        };
                    };
                    retain_alone_input.checked = false;
                }
            },
            //备注函数
            aloneRemakFun(id,text){
                this.remarkObj.remarkText = text;
                this.remarkObj.remarkFlag = true;
                this.remarkObj.id = id;
            },
            //确定添加备注按钮
            aloneRemakSureFun(){
                axios({
                    url:'../bingo/retain_order.php?action=remark',
                    method:"post",
                    data:{
                        id:this.remarkObj.id,
                        remark:this.remarkObj.remarkText
                    },
                }).then(res=>{
                    if(res.data.code == 100){
                        this.dataFun()
                    }else{
                        this.$Message.info({
                            content:res.data.msg,
                            closable:false,
                            duration:5,
                        })
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //分页函数
            //向后转页面 —
            uppage:function(){
                if(this.num>1){
                    this.num -= 1;
                }else if(this.num<1){
                    alert('没有该页码')
                }else{
                    return
                }
                this.axfun(this.num);
            },
            //向前转页面 +
            downpage:function(){
                this.num = Number(this.num); //之前的显示数字其本质为字符串导致无法数字计算
                if(this.num<this.pages){
                    this.num = this.num + 1;
                }else{
                    return
                };
                this.axfun(this.num)
            },
            //直接去某页面
            gotopage:function () {
                let val = this.$refs.num.value;
                if(val > this.pages||val<1){
                    //页数框页码重置
                    this.$refs.num.value = this.num;
                    alert('没有该页码');
                }else{
                    this.num = Math.round(this.num);
                    this.num = val;
                    this.axfun(this.num)
                }
            },
            //直接去首页
            firstpage:function () {
                //如果num已经是第一页了，就不再请求了
                if(this.num == 1){
                    return
                }
                this.num = 1;
                this.axfun(this.num)
            },
            //直接去末尾页
            llastpage:function () {
                //如果已经等于最后已页，就不再请求
                if(this.num == this.pages){
                    return
                }
                this.num = this.pages;
                this.axfun(this.num)
            },
            //跳转后把页面值传入，用来获取要跳转页面的数据，此函数为上面所有跳转函数的通用操作
            axfun:function(page){
                this.dataFun(page)
            },
        },
        created(){
            this.num = busData.rememberObj.alone.num?busData.rememberObj.alone.num:1;
            this.searchAloneFlag  = busData.rememberObj.alone.searchAloneFlag;
            this.searchObj  = busData.rememberObj.alone.searchObj;
            this.searchObj.carrier = busData.carrier;

            if(busData.detailedObj.detailedFlag){
                this.searchObj = Object.assign(this.searchObj,busData.detailedObj);
            };
            this.dataFun();
        },
        beforeDestroy(){
            busData.rememberObj.alone.num = this.num;
            busData.rememberObj.alone.searchAloneFlag = this.searchAloneFlag;
            busData.rememberObj.alone.searchObj = this.searchObj;
        }
    });
    let store = new Vuex.Store({
        state:{
            detailed:{},
        },
        mutations:{

        }
    })
    new Vue({
        el:'#retainOrder',
        store,
        data:{
            name:'name1',
        },
        created(){

        }
    })
</script>


</body>
</html>
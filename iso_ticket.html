<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>国际</title>
  <link rel="stylesheet" href="../resource/iview-2.0/dist/styles/iview.css">
  <script src="../vue/vue.js"></script>
  <script src="../resource/iview-2.0/dist/iview.js"></script>
  <style>
  .ivu-card-body {
    padding: 2px;
    /*padding-left: 0px;*/
    /*padding-right: 0px;*/
    /*padding-bottom: 3px;*/

  }

  .ivu-card-head {
    border-top: 3px solid #5cadff;
    border-bottom: 1px solid #5cadff;
    padding: 9px 16px;
    line-height: 1;
  }

  .c {
    border-top: 3px solid #5cadff;
    /*border-bottom: 1px solid #5cadff;*/
    /*padding: 9px 16px;*/
    /*line-height: 1;*/
  }

  .ivu-table .demo-table-info-row td {
    background-color: #2db7f5;
    color: #fff;
  }

  .ivu-table .demo-table-error-row td {
    background-color: #ff6600;
    color: #fff;
  }

  .ivu-table td.demo-table-info-column {
    /*background-color: #2db7f5;*/
    /*color: #ff6600;*/
  }

  .chooseChild {
    width: 200px;
    /*margin-right: 10px;*/
    margin-top: 5px;
  }

  .ivu-input-group {
    display: table;
    border-collapse: separate;
    position: relative;
    font-size: 12px;
    top: 0px;
  }

  .ivu-select-single .ivu-select-selection .ivu-select-placeholder {
    color: #000000;
  }

  .ivu-table-cell {
    padding-left: 1px;
    padding-right: 1px;
  }
  </style>
</head>
<body>
<div id="isoApp">
  <Back-Top></Back-Top>
  <!--<Spin fix size="large" v-if="LoadingFlag"></Spin>-->
  <div>
    <com-Log></com-Log>
    <!--<p slot="title">国际</p>-->
    <Tabs :animated="false" v-model="name" @on-click="tabChange" size="small" type="line">
      <Tab-Pane label="未锁定" name="ticketName">
        <com-Ticket v-if="name==='ticketName'" style="margin-top: -10px"></com-Ticket>
      </Tab-Pane>
      <Tab-Pane label="已锁定" name="retreatName">
        <com-Retreat v-if="name==='retreatName'" style="margin-top: -10px"></com-Retreat>
      </Tab-Pane>
    </Tabs>
  </div>
</div>
<template id="isoTicket">
  <Row span="24">
    <i-Col>
      <Card dis-hover style="margin-bottom: 2px;margin-top: -5px">
        <i-Button type="primary" size="small" @click="searchFlagFun">
          <Icon type="ios-search"></Icon>
          搜索
        </i-Button>
        <choose v-if="searchFlag"
                @chooselock="chooselock"
                @conditionsfun="conditionsFun"
                @searchflagfun="searchFlagFun"
                :conditionsFlag="conditionsFlag">
        </choose>
        <conditions v-if="conditionsFlag"
                    @conditionsfun="conditionsFun"
                    @choosefun="choosefun">
        </conditions>
        <!--<info v-if="infoFlag"-->
        <!--@infofun="infoFun"-->
        <!--@chooseinfo="chooseinfo">-->
        <!--</info>-->

        <!--<i-Button type="primary" size="small" @click="exportData">-->
        <!--<Icon type="ios-download-outline"></Icon>-->
        <!--导出数据-->
        <!--</i-Button>-->
      </Card>
    </i-Col>
    <i-Col>
      <i-Table ref="ticketTable" border highlight-row stripe height="600" size="small" :loading="loading"
               :columns="ticketColumns" :data="ticketData"></i-Table>
      <div style="float: right;margin-top:2px;margin-right: 20px">
        <Page show-total
              :total="pageTotal"
              :current="pageNum"
              show-elevator
              :page-size=20
              @on-change="handlePage"
              @on-page-size-change='handlePageSize'>
        </Page>
      </div>
    </i-Col>
  </Row>
</template>
<template id="isoRetreat">
  <Row span="24">
    <i-Col>
      <Card dis-hover style="margin-bottom: 2px;margin-top: -5px">
        <i-Button type="primary" size="small" @click="searchFlagFun">
          <Icon type="ios-search"></Icon>
          搜索
        </i-Button>
        <choose v-if="searchFlag"
                @chooselock="chooselock"
                @conditionsfun="conditionsFun"
                @searchflagfun="searchFlagFun"
                :conditionsFlag="conditionsFlag">
        </choose>
        <conditions v-if="conditionsFlag"
                    @conditionsfun="conditionsFun"
                    @choosefun="choosefun">
        </conditions>
        <!--<info v-if="infoFlag"-->
        <!--@infofun="infoFun"-->
        <!--@chooseinfo="chooseinfo">-->
        <!--</info>-->

      </Card>
    </i-Col>
    <i-Col>
      <i-Table ref="ticketTable" border highlight-row stripe height="600" size="small"
               :loading="loading"
               :columns="retreatColumns"
               :data="retreatData">
      </i-Table>
      <div style="float: right;margin-top:2px;margin-right: 20px">
        <Page show-total
              :total="pageTotal"
              :current="pageNum"
              show-elevator
              :page-size=20
              @on-change="handlePage"
              @on-page-size-change='handlePageSize'>
        </Page>
      </div>
    </i-Col>
  </Row>
</template>
<template id="isoLog">
  <Modal :styles="{top: '20px'}" cancel-text :closable="false" :mask-closable="false" v-model="LogModal" title="操作日志"
         @on-cancel="closeLog"
         @on-ok="closeLog">
    <i-Table v-if="isoLogData" border height="380" :columns="isoLogColumns" :data="isoLogData"></i-Table>
  </Modal>
</template>
<!--详细查询的dom-->
<template id="conditions">
  <div>
    <Modal :styles="{top: '20px'}" v-model="conditionsModal" @on-ok="choosefun" @on-cancel="conditionsCancel"
           title="详细查询">
      <!--<Divider>详细查询</Divider>-->
      <div>
        <span>查单排序条件</span>
        <Radio-Group v-model="ticketTime">
          <Radio label="1">
            <span>进单时间</span>
          </Radio>
          <Radio label="2">
            <span>起飞时间</span>
          </Radio>
        </Radio-Group>
      </div>
      <div id="hangsi">
        <span>选择航空公司</span>
        <div style="display: inline-block">
          <Icon type="ios-paper-plane" size="10px" />
        </div>
        <div style="border-bottom: 1px solid #e9e9e9;padding-bottom:6px;margin-bottom:6px;">
          <Checkbox
            :indeterminate="airlineIndeterminate"
            :value="airlineCheckAll"
            @on-change="airlineCheckAllFun">全选
          </Checkbox>
        </div>
        <Checkbox-Group v-model="airlineGroup" @on-change="airlineGroupChange">
          <Checkbox :label="ele" v-for="(ele,index) in airline" :key="index"></Checkbox>
        </Checkbox-Group>
      </div>
      <div id="pingtai">
        <span>选择平台</span>
        <div style="display: inline-block">
          <Icon type="ios-home" size="15px" />
        </div>
        <div style="border-bottom: 1px solid #e9e9e9;padding-bottom:6px;margin-bottom:6px;">
          <Checkbox :indeterminate="tableIndeterminate" :value="tableCheckAll"
                    @on-change="tableCheckAllFun" ref="">全选
          </Checkbox>
        </div>
        <Checkbox-Group v-model="tableCheckGroup" @on-change="tableCheckGroupChange">
          <Checkbox :label="ele" v-for="(ele,index) in tableGroup" :key="index" :value="index"></Checkbox>
        </Checkbox-Group>
      </div>
    </Modal>
  </div>
</template>
<!--条件查询dom-->
<template id="choosetem">
  <Card dis-hover id="choose" style="margin-top: 5px">
    <Row type="flex" justify="start" :gutter="5" class="code-row-bg">
      <!--航司选择框-->
      <i-Col>
        <i-Input disabled placeholder="航司" style="width:150px;">
          <i-Select style="width: 100px;" slot="append" v-model="carrier" placeholder="全部">
            <i-Option style="text-align:left" v-for="item in hsCityList" :value="item.value"
                      :key="item.value">{{ item.label }}
            </i-Option>
          </i-Select>
        </i-Input>
      </i-Col>
      <!--平台选择-->
      <i-Col>
        <i-Input disabled placeholder="平台" style="width:150px;">
          <i-Select style="width: 100px;" slot="append" v-model="ticketTable" placeholder="全部">
            <i-Option style="text-align:left" v-for="item in ptCityList" :value="item.value"
                      :key="item.value">{{ item.label }}
            </i-Option>
          </i-Select>
        </i-Input>
      </i-Col>
      <!--日期选择框-->
      <i-Col>
        <Date-picker v-model="payTimeStart"
                     type="date"
                     placement="bottom-end"
                     placeholder="支付开始日期"
                     style="width: 200px">
        </Date-picker>
      </i-Col>
      <i-Col>
        <Date-picker v-model="payTimeEnd"
                     type="date"
                     placement="bottom-end"
                     placeholder="支付结束日期"
                     style="width: 200px">
        </Date-picker>
      </i-Col>
      <!--起飞日期-->
      <i-Col>
        <Date-picker type="date"
                     v-model="depDataStart"
                     placement="bottom-end"
                     placeholder="起飞开始日期"
                     style="width: 200px">
        </Date-picker>
      </i-Col>
      <i-Col>
        <div>
          <Date-picker type="date"
                       v-model="depDataEnd"
                       placement="bottom-end"
                       placeholder="起飞结束日期"
                       style="width: 200px">
          </Date-picker>
        </div>
      </i-Col>
    </Row>
    <Row type="flex" justify="start" :gutter="5" class="code-row-bg">
      <i-Col>
        <!--大PNR-->
        <i-input placeholder="大PNR" class="chooseChild" v-model="bigNumber">
          <span slot="prepend">大PNR</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--小PNR-->
        <i-input placeholder="小PNR" class="chooseChild" v-model="smartNumber">
          <span slot="prepend">小PNR</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--换大PNR-->
        <i-input placeholder="换大PNR" class="chooseChild" v-model="big">
          <span slot="prepend">换大PNR</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--换小PNR-->
        <i-input placeholder="换小PNR" class="chooseChild" v-model="smart">
          <span slot="prepend">换小PNR</span>
        </i-input>
      </i-Col>
    </Row>
    <Row type="flex" justify="start" :gutter="5" class="code-row-bg" style="margin-bottom: 5px">
      <i-Col>
        <!--乘客姓名-->
        <i-input placeholder="乘客姓名" class="chooseChild" v-model="passname">
          <span slot="prepend">乘客姓名</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--平台政策代码-->
        <i-input placeholder="平台政策代码" class="chooseChild" v-model="policyCode">
          <span slot="prepend">政策代码</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--航班号-->
        <i-input placeholder="航班号" class="chooseChild" v-model="flightNumber">
          <span slot="prepend">航班号</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--系统订单号-->
        <i-input placeholder="系统订单号" class="chooseChild" v-model="orderid">
          <span slot="prepend">系统订单</span>
        </i-input>
      </i-Col>
      <i-Col>
        <!--平台订单号-->
        <i-input placeholder="平台订单号" class="chooseChild" v-model="orderNo">
          <span slot="prepend">平台订单</span>
        </i-input>
      </i-Col>
    </Row>
    <Row :gutter="5" type="flex" justify="end" class="code-row-bg">
      <i-Col>
        <!--条件筛选-->
        <i-button @click="condition">条件筛选</i-button>
      </i-Col>
      <i-Col>
        <!--确认筛选条件-->
        <i-Button type="primary" @click="chooselock">确认筛选</i-Button>
      </i-Col>
      <i-Col>
        <i-Button type="primary" @click="closeSai">关闭筛选</i-Button>
      </i-Col>
    </Row>
  </Card>
</template>

<template id="info">
  <div>
    <Modal v-model="infoModal" footer-hide fullscreen title="Fullscreen Modal">
      <div>This is a fullscreen modal</div>
    </Modal>
  </div>
</template>
</body>
<script src="../vue/axios.min.js"></script>
<script src="../vue/vuex.js"></script>
<script src="../resource/main/index/http2.js"></script>
<script>
Vue.prototype.$get = get
Vue.prototype.$post = post
Vue.component('conditions', {
  template: '#conditions',
  props: [],
  computed: {},
  data() {
    return {
      conditionsModal: true,
      //单选默认
      ticketTime: '进单时间',
      //~~~航司~~~
      //航司数据
      airlineIndeterminate: false,
      //航司全选按钮
      airlineCheckAll: false,
      //航司数组
      airline: ['3U', '9C', 'A6', 'BK', 'CA', 'CZ', 'DZ',
        'EU', 'G5', 'GJ', 'GX', 'GY', 'JR', 'KN', 'KY', 'LT', 'MF',
        ' NS', 'PN', 'QW', 'RY', 'SC', 'TV', 'UQ', 'ZH'],
      //选择后的航司值
      airlineGroup: [],
      //~~~平台~~~
      tableIndeterminate: false,
      tableCheckAll: false,
      //平台数组
      tableGroup: ['xss', 'xsg', 'ttr', '携程', '淘宝', '517na', '酷讯',
        '同程', '淘宝B', 'TB', '携程团队'],
      tableCheckGroup: []
    }
  },
  methods: {
    conditionsCancel() {
      this.$emit('conditionsfun')
      this.conditionsModal = false
      this.$Message.info('成功关闭详细查询')

    },
    //航司函数
    airlineCheckAllFun() {
      if (this.airlineIndeterminate) {
        this.airlineCheckAll = false
      } else {
        this.airlineCheckAll = !this.airlineCheckAll
      }
      this.airlineIndeterminate = false

      if (this.airlineCheckAll) {
        this.airlineGroup = this.airline
      } else {
        this.airlineGroup = []
      }
    },
    airlineGroupChange(data) {
      if (data.length === this.airline.length) {
        this.airlineIndeterminate = false
        this.airlineCheckAll = true
      } else if (data.length > 0) {
        this.airlineIndeterminate = true
        this.airlineCheckAll = false
      } else {
        this.airlineIndeterminate = false
        this.airlineCheckAll = false
      }
    },
    //平台函数
    tableCheckAllFun() {
      if (this.tableIndeterminate) {
        this.tableCheckAll = false
      } else {
        this.tableCheckAll = !this.tableCheckAll
      }
      this.tableIndeterminate = false

      if (this.tableCheckAll) {
        this.tableCheckGroup = this.tableGroup
      } else {
        this.tableCheckGroup = []
      }
    },
    tableCheckGroupChange(data) {
      if (data.length === this.tableGroup.length) {
        this.tableIndeterminate = false
        this.tableCheckAll = true
      } else if (data.length > 0) {
        this.tableIndeterminate = true
        this.tableCheckAll = false
      } else {
        this.tableIndeterminate = false
        this.tableCheckAll = false
      }
    },
    //条件筛选确定筛选按钮
    choosefun() {
      let choosear = [[this.ticketTime], this.airlineGroup, this.tableCheckGroup]
      console.log(choosear)
      this.$emit('choosefun', choosear)
    }
  }
})
Vue.component('choose', {
  template: '#choosetem',
  // props:['conditionsFlag'],
  data() {
    return {
      //航司选择
      hsCityList: [
        {
          value: '',
          label: '全部'
        },
        {
          value: '3U',
          label: '3U'
        },
        {
          value: '9C',
          label: '9C'
        },
        {
          value: 'ZH',
          label: 'ZH'
        },
        {
          value: 'MF',
          label: 'MF'
        },
        {
          value: 'CA',
          label: 'CA'
        },
        {
          value: 'BK',
          label: 'BK'
        },
        {
          value: 'HO',
          label: 'HO'
        },
        {
          value: 'EU',
          label: 'EU'
        },
        {
          value: 'SC',
          label: 'SC'
        },
        {
          value: 'KY',
          label: 'KY'
        },
        {
          value: 'NS',
          label: 'NS'
        },
        {
          value: 'QW',
          label: 'QW'
        },
        {
          value: 'TV',
          label: 'TV'
        },
        {
          value: 'G5',
          label: 'G5'
        },
        {
          value: 'DZ',
          label: 'DZ'
        },
        {
          value: 'UQ',
          label: 'UQ'
        },
        {
          value: 'GJ',
          label: 'GJ'
        },
        {
          value: 'JR',
          label: 'JR'
        },
        {
          value: 'A6',
          label: 'A6'
        },
        {
          value: 'GY',
          label: 'GY'
        },
        {
          value: 'RY',
          label: 'RY'
        }
      ],

      carrier: null,
      //平台选择
      ptCityList: [
        {
          value: '',
          label: '全部'
        },
        {
          value: '淘宝9C',
          label: '淘宝9C'
        },
        {
          value: '去哪儿',
          label: '去哪儿'
        }
      ],

      ticketTable: null,

      payTimeStart: null,//支付开始时间
      payTimeEnd: null,//支付结束时间
      depDataStart: null,//起飞开始时间
      depDataEnd: null,//起飞结束时间

      payTime: [], //支付日期
      flyTime: [], //起飞日期

      bigNumber: null, //大pnr
      smartNumber: null,//小pnr
      big: null,//换大pnr
      smart: null, //换小pnr
      passname: null, //乘客姓名
      policyCode: null, //政策代码
      flightNumber: null, //航班号

      orderid: null,//系统订单号

      orderNo: null//平台订单号
    }
  },
  computed: {
    name() {
      return this.$store.state.name
    }
  },
  methods: {
    //确认筛选按钮的函数，更新为筛选后的数据
    chooselock: function () {
      let obj = {
        carrier: this.carrier,

        payTimeStart: this.payTimeStart,
        payTimeEnd: this.payTimeEnd,
        depDataStart: this.depDataStart,
        depDataEnd: this.depDataEnd,

        ticketTable: this.ticketTable,
        bigNumber: this.bigNumber,
        smartNumber: this.smartNumber,
        big: this.big,
        smart: this.smart,
        passname: this.passname,
        policyCode: this.policyCode,
        flightNumber: this.flightNumber,
        orderid: this.orderid,
        orderNo: this.orderNo
        //    还有个判断是否在锁定页面的开关？
      }
      return this.$emit('chooselock', obj, true)
    },

    closeSai() {
      this.$emit('searchflagfun')
    },
    //条件筛选按钮触发
    condition() {
      // let sss=this.conditionsModal = true;
      this.$emit('conditionsfun')
    }
  }
})
Vue.component('info', {
  template: 'info',
  data() {
    return {
      infoModal: true
    }
  }
})
//出票未锁组件
const comTicket = {
  template: '#isoTicket',
  data() {
    return {
      ticketColumns: [
        // {
        //     type: 'selection',
        //     width: 50,
        //     align: 'center',
        //     fixed: 'left'
        // },
        {
          align: 'center',
          width: 40,
          fixed: 'left',
          render: (h, params) => {
            return h('span', params.index + (this.pageNum - 1) * this.pageSize + 1)
          }
        },
        {
          title: '平台',
          key: 'ticketTable',
          align: 'center'
        },
        {
          title: '时长',
          key: 'time',
          align: 'center',
          width: 50
        },
        {
          title: '订单信息',
          align: 'center',
          children: [
            {
              title: '订单ID',
              align: 'center',
              render: (h, params) => {
                return h('div', [
                  h('a', {
                    on: {
                      click: () => {
                        this.showTicket(params.row.id)
                      }
                    }
                  }, params.row.id)
                ])
              }
            },
            {
              title: '订单号',
              align: 'center',
              width: 120,
              render: (h, params) => {
                return h('div', [
                  h('a', {
                    on: {
                      click: () => {
                        this.showOrder(params.row.id)
                      }
                    }
                  }, params.row.orderNo),
                  h('Icon', {
                    props: {
                      type: 'ios-copy',
                      size: 15
                    },
                    style: {
                      cursor: 'pointer'
                    },
                    on: {
                      click: () => {
                        this.copyOrderNo(params.row.orderNo)
                      }
                    }
                  })
                ])
              }
            }
          ]
        },
        {
          title: '航班信息',
          align: 'center',
          width: 170,
          className: 'demo-table-info-column',
          render: (h, params) => {
            return h('div', [
              h('Tooltip', {
                props: {
                  // theme:'light',
                  placement: 'top',
                  transfer: true,
                  maxWidth: '210',
                  content: '航班号: ' + params.row.flight[0].flightNumber +
                    ', 起飞地: ' + params.row.flight[0].depAirport +
                    ', 到达地: ' + params.row.flight[0].arrAirport +
                    ', 乘机人数: ' + params.row.population + ' 人 ' +
                    ', 起飞日期: ' + params.row.flight[0].depData +
                    ', 起飞时间: ' + params.row.flight[0].depTime
                }
              }, [
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.flight[0].flightNumber),
                h('span', params.row.flight[0].depAirport + '-'),
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.flight[0].arrAirport),
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.population + '人'),
                h('br'),
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.flight[0].depData),
                // h('span', new Date(params.row.flight[0].depTime).Format('hh:mm')),
                h('span', params.row.flight[0].depTime)
              ])
            ])
          }
        },
        {
          title: '余位',
          align: 'center',
          render: (h, params) => {
            return h('div', [
              h('span', '[' + params.row.flight[0].cabin + '/'),
              h('span', params.row.flight[0].maxSeats + ']')
            ])
          }
        },
        {
          title: '政策信息',
          align: 'center',
          children: [
            {
              title: '政策代码',
              key: 'policyCode',
              align: 'center',
              // width: 150,
              render: (h, params) => {
                let texts = ''
                if (params.row.policyCode !== null) {
                  if (params.row.policyCode.length > 8) {
                    //进行截取列显示字数
                    texts = params.row.policyCode.substring(0, 8) + '...'
                  } else {
                    texts = params.row.policyCode
                  }
                }
                return h('div', [
                  h('Tooltip', {
                    props: {
                      // theme:'light',
                      placement: 'top',
                      transfer: true
                    }
                  }, [
                    texts,
                    h('div', {
                      slot: 'content',
                      style: {
                        whiteSpace: 'normal',
                        wordBreak: 'break-all'
                      }
                    }, params.row.policyCode)
                  ])
                ])
              }
            },
            {
              title: '政策备注',
              align: 'center',
              // width: 80,
              render: (h, params) => {
                return h('div', [
                  h('span', {
                    style: {
                      color: 'red'
                    }
                  }, params.row.remarks)
                ])
              }
            }
          ]
        },
        {
          title: '收款',
          key: 'collection',
          align: 'center'

        },
        {
          title: '备注',
          key: 'orderMarkes',
          align: 'center',
          // width: 160,
          render: (h, params) => {
            let texts = ''
            if (params.row.orderMarkes !== null) {
              if (params.row.orderMarkes.length > 8) {
                //进行截取列显示字数
                texts = params.row.orderMarkes.substring(0, 8) + '...'
              } else {
                texts = params.row.orderMarkes
              }
            }
            return h('div', [
              h('Tooltip', {
                props: {
                  // theme:'light',
                  placement: 'top',
                  transfer: true
                }
              }, [
                texts,
                h('div', {
                  slot: 'content',
                  style: {
                    whiteSpace: 'normal',
                    wordBreak: 'break-all'
                  }
                }, params.row.orderMarkes)
              ])
            ])
          }
        },
        {
          title: '订单操作',
          align: 'center',
          width: 150,
          fixed: 'right',
          render: (h, params) => {
            if (params.row.carrier === '9C') {
              return h('div', [
                h('Button', {
                  props: {
                    type: 'error',
                    size: 'small'
                    // icon: 'md-battery-charging',
                  },
                  style: {
                    marginRight: '3px'
                  },
                  on: {
                    click: () => {
                      this.LockId(params.row.carrier, params.row.id)
                    }
                  }
                }, '锁单'),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要重启支付吗?',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.rePay(params.row.id)
                        // this.$Message.info('点击了确定')
                      },
                      'on-cancel': () => {
                        this.$Message.info('重启支付已取消!')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                        // icon: 'md-battery-charging',
                      },
                      style: {
                        marginRight: '3px'
                      }
                    }, '重付')
                  ])
                ]),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要重启订票吗?',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.reOrder(params.row.id, false)
                      },
                      'on-cancel': () => {
                        this.$Message.info('重启订票已取消!')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                        // icon: 'md-battery-charging',
                      }
                    }, '重订')
                  ])
                ])
              ])
            }

          }
        }

      ],
      ticketData: [],

      loading: false,
      pageTotal: undefined,
      pageNum: 1,
      pageSize: 20,

      infoFlag: false,

      searchFlag: false,
      choose: false,
      chooseObj: null,
      platformOrder: null,
      conditionsFlag: false
    }
  },
  mounted() {
    this.initTable()
    // this.initFormatter();
  },
  methods: {
    initFormatter() {
      Date.prototype.Format = function (fmt) {
        let o = {
          'M+': this.getMonth() + 1,                 //月份
          'd+': this.getDate(),                    //日
          'h+': this.getHours(),                   //小时
          'm+': this.getMinutes(),                 //分
          's+': this.getSeconds(),                 //秒
          'q+': Math.floor((this.getMonth() + 3) / 3), //季度
          'S': this.getMilliseconds()             //毫秒
        }
        if (/(y+)/.test(fmt))
          fmt = fmt.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length))
        for (var k in o)
          if (new RegExp('(' + k + ')').test(fmt))
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)))
        return fmt
      }
    },
    //初始化
    initTable() {
      if (this.loading) return
      this.loading = true
      let postData = {
        'action': 'query',
        'page': this.pageNum,
        'islock': false
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          // console.log(JSON.stringify(response.data))
          this.ticketData = response.data.row
          this.pageTotal = response.data.count
          this.loading = false
        } else {
          this.$Message.error({
            content: '未锁单数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    },
    //分页切换
    handlePage(value) {
      this.pageNum = value
      this.initTable()
    },
    //条数切换
    handlePageSize(value) {
      this.pageSize = value
      this.initTable()
    },
    //导出
    exportData() {
      this.$refs.ticketTable.exportCsv({
        filename: '国际出票'
      })
    },
    //锁单
    LockId(carrier, id) {
      let postData = {
        'action': 'doLock',
        'orderid': id
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (carrier === '9C') {
            if (response.data.success === true) {
              this.initTable()
              this.$Message.success(response.data.msg)
            } else {
              this.$Message.error({
                content: response.data.msg,
                duration: 3
              })
            }
          } else {
            if (response.data.success === true) {
              window.location.href = '../template/iso_info.html?id=' + id
            } else {
              this.$Message.error({
                content: response.data.msg,
                duration: 3
              })
            }
          }
        } else {
          this.$Message.error({
            content: '锁单数据异常,请联系技术人员!',
            duration: 6
          })
        }

      })
    },
    //重启支付
    rePay(orderId) {
      let postData = {
        'action': 'rePay',
        'orderid': orderId
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initTable()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '重启支付数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    },
    //重启订票
    reOrder(orderId, exchange) {
      let postData = {
        'action': 'reOrder',
        'orderid': orderId,
        'changeAccount': exchange
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initTable()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '重启订票数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    },
    //订单号复制
    copyOrderNo(orderNo) {
      let oInput = document.createElement('input')
      oInput.value = orderNo
      document.body.appendChild(oInput)
      oInput.select()
      document.execCommand('Copy')
      document.body.removeChild(oInput)
      this.$Message.success('成功复制订单号')
    },
    //日志函数
    showOrder(orderId) {
      let postData = {
        'action': 'showLog',
        'orderid': orderId
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.$store.state.isoLogModal = true
            this.$store.state.isoLogData = response.data.row
          } else {
            this.$Message.info(response.data.msg)
          }
        } else {
          this.$Message.error({
            content: '日志数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    },
    //点击订单号，触发游客模式
    showTicket(orderId) {
      this.$Message.success(orderId)
      window.location.href = '../template/iso_info.html?id=' + orderId + '&see=true'
    },
    //搜索框显示隐藏按钮触发函数（非记忆搜索框）
    searchFlagFun() {
      this.searchFlag = !this.searchFlag
    },
    //条件筛选关闭函数（记忆搜索框功能）
    conditionsFun() {
      this.conditionsFlag = !this.conditionsFlag
    },
    infoFun() {
      this.infoFlag = !this.infoFlag
    },
    chooseinfo() {

    },
    //搜索框确认筛选函数（非记忆搜索功能）
    chooselock(obj, choose, page) {

      //当obj传入，意味搜索打开，obj是搜索的条件;且choose作为true传进来;
      let pagee = undefined
      if (obj) {
        this.chooseObj = JSON.parse(JSON.stringify(obj))
      }
      page ? pagee = page : pagee = 1
      //如果翻页，翻页函数会通过此判断翻页是否有搜索条件
      choose ? this.choose = true : this.choose = false
      obj.page = pagee
      obj.flag = true
      obj.action = 'query'
      obj.islock = false

      let postData = obj

      console.log('isoTicket >',JSON.stringify(postData))

      if (this.loading) return
      this.loading = true

      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          this.ticketData = response.data.row
          this.pageTotal = response.data.count
          this.loading = false
        } else {
          this.$Message.error({
            content: '搜索未锁单数据异常',
            duration: 6
          })
        }
      })
    },
    //条件筛选触发函数
    choosefun: function (choosear, pageNum) {
      var pagee = ''
      if (pageNum) {
        pagee = pageNum
      } else {
        pagee = 1
      }
      alert(JSON.stringify(choosear))
      if (this.loading) return
      this.loading = true

      // let postData = {
      //     "action": "showLog",
      //     "orderid": orderId
      // };
      // this.$post("ticketIntl.php", postData).then((response) => {
      //     this.ticketData = response.data.row;
      //     this.pageTotal = response.data.count;
      //     this.loading = false
      // });

      axios({
        url: 'bingo/ticking.php?action=choose',
        method: 'post',
        data: {
          choosear,
          flag: true,
          page: pagee
        }
      }).then((response) => {
        this.ticketData = response.data.row
        this.pageTotal = response.data.count
        this.loading = false
      }).catch((error) => {
        console.log(error)
      })
    }
  }
}
//出票已锁组件
const comRetreat = {
  template: '#isoRetreat',
  data() {
    return {
      searchFlag: false,
      ticketNoVal: null,
      cashVal: null,
      retreatColumns: [
        {
          align: 'center',
          width: 40,
          fixed: 'left',
          render: (h, params) => {
            return h('span', params.index + (this.pageNum - 1) * this.pageSize + 1)
          }
        },
        {
          title: '平台',
          key: 'ticketTable',
          align: 'center'
          // sortable: true
        },
        {
          title: '处理人',
          key: 'lock',
          align: 'center'
        },
        {
          title: '时长',
          key: 'time',
          align: 'center',
          width: 50
        },
        {
          title: '订单信息',
          align: 'center',
          children: [
            {
              title: '订单ID',
              align: 'center',
              render: (h, params) => {
                return h('div', [
                  h('a', {
                    on: {
                      click: () => {
                        this.showOrderTwo(params.row.id)
                      }
                    }
                  }, params.row.id)
                ])
              }
            },
            {
              title: '订单号',
              align: 'center',
              width: 120,
              render: (h, params) => {
                return h('div', [
                  h('a', {
                    on: {
                      click: () => {
                        this.showOrderLog(params.row.id)
                      }
                    }
                  }, params.row.orderNo),
                  h('Icon', {
                    props: {
                      type: 'ios-copy',
                      size: 15
                    },
                    style: {
                      cursor: 'pointer'
                    },
                    on: {
                      click: () => {
                        this.copyOrderNo(params.row.orderNo)
                      }
                    }
                  })
                ])
              }
            }
          ]
        },
        {
          title: '航班信息',
          align: 'center',
          width: 170,
          // className: 'demo-table-info-column',
          render: (h, params) => {
            return h('div', [
              h('Tooltip', {
                props: {
                  // theme:'light',
                  placement: 'top',
                  transfer: true,
                  maxWidth: '210',
                  content: '航班号: ' + params.row.flight[0].flightNumber +
                    ', 起飞地: ' + params.row.flight[0].depAirport +
                    ', 到达地: ' + params.row.flight[0].arrAirport +
                    ', 乘机人数: ' + params.row.population + ' 人 ' +
                    ', 起飞日期: ' + params.row.flight[0].depData +
                    ', 起飞时间: ' + params.row.flight[0].depTime
                }
              }, [
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.flight[0].flightNumber),
                h('span', params.row.flight[0].depAirport + '-'),
                h('span', {
                  style: {
                    marginRight: '10px'
                  }
                }, params.row.flight[0].arrAirport),
                h('span', params.row.population + '人'),
                h('br'),
                h('span', {
                  style: {
                    marginRight: '5px'
                  }
                }, params.row.flight[0].depData),
                h('span', params.row.flight[0].depTime)
              ])
            ])
          }
        },
        {
          title: '余位',
          align: 'center',
          render: (h, params) => {
            return h('div', [
              h('font', '[' + params.row.flight[0].cabin + '/'),
              h('font', params.row.flight[0].maxSeats + ']')
            ])
          }
        },
        {
          title: '政策信息',
          align: 'center',
          children: [
            {
              title: '政策代码',
              key: 'policyCode',
              align: 'center',
              render: (h, params) => {
                let texts = ''
                if (params.row.policyCode !== null) {
                  if (params.row.policyCode.length > 8) {
                    //进行截取列显示字数
                    texts = params.row.policyCode.substring(0, 8) + '...'
                  } else {
                    texts = params.row.policyCode
                  }
                }
                return h('div', [
                  h('Tooltip', {
                    props: {
                      // theme:'light',
                      placement: 'top',
                      transfer: true
                    }
                  }, [
                    texts,
                    h('div', {
                      slot: 'content',
                      style: {
                        whiteSpace: 'normal',
                        wordBreak: 'break-all'
                      }
                    }, params.row.policyCode)
                  ])
                ])
              }
            },
            {
              title: '政策备注',
              key: 'remarks',
              align: 'center'
            }
          ]
        },
        {
          title: '收款',
          key: 'collection',
          align: 'center'
        },
        {
          title: '票号回帖',
          align: 'center',
          render: (h, params) => {
            if (params.row.carrier === '9C' && params.row.permission === true && params.row.ticketTable === '淘宝9C') {
              return h('div', [
                h('div', [
                  h('Poptip', {
                    props: {
                      transfer: true,
                      placement: 'right-start',
                      width: '180',
                      title: '票号回帖',
                      wordWrap: true
                    },
                    on: {
                      'on-popper-hide': () => {
                        this.ticketNoVal = null
                        this.cashVal = null
                      },
                      'on-popper-show': () => {
                        this.ticketNoVal = null
                        this.cashVal = null
                      }
                    }
                  }, [
                    [
                      h('div', {
                          slot: 'content'
                        },
                        [
                          h('Input', {
                            props: {
                              type: 'text',
                              size: 'small',
                              placeholder: '票号',
                              value: this.ticketNoVal
                            },
                            style: {
                              width: '130px',
                              marginTop: '-10px'
                            },
                            on: {
                              input: (tVal) => {
                                this.ticketNoVal = tVal
                                console.log(tVal)
                              }
                            }
                          }),
                          h('Input', {
                            props: {
                              type: 'text',
                              size: 'small',
                              placeholder: '支付金额',
                              value: this.cashVal
                            },
                            style: {
                              width: '130px',
                              marginTop: '-5px'
                            },
                            on: {
                              input: (cVal) => {
                                this.cashVal = cVal
                                console.log(cVal)
                              }
                            }
                          }),
                          h('Button', {
                            props: {
                              type: 'primary',
                              size: 'small'
                            },
                            style: {
                              marginTop: '5px',
                              float: 'right'
                            },
                            on: {
                              click: () => {
                                this.reTall(params.row.id, this.ticketNoVal, this.cashVal)
                              }
                            }
                          }, '确定'),
                          h('Button', {
                            props: {
                              type: 'primary',
                              size: 'small'
                            },
                            style: {
                              marginTop: '5px'
                            },
                            on: {
                              click: () => {
                                this.ticketNoVal = params.row.ticketNo
                              }
                            }
                          }, '传入票号')
                        ]
                      )
                    ],
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      }
                      // style: {
                      //   marginTop: '0px',
                      //   marginRight: '0px',
                      //   marginBottom: '0px'
                      // }
                    }, '回帖')
                  ])
                ])
              ])
            }
          }
        },
        {
          title: '平台状态',
          key: 'platformStatus',
          align: 'center'
        },
        {
          title: '航司状态',
          key: 'airlineStatus',
          align: 'center'
        },
        {
          title: '备注',
          // ellipsis: true,
          align: 'center',
          render: (h, params) => {
            let texts = ''
            if (params.row.orderMarkes !== null) {
              if (params.row.orderMarkes.length > 8) {
                //进行截取列显示字数
                texts = params.row.orderMarkes.substring(0, 8) + '...'
              } else {
                texts = params.row.orderMarkes
              }
            }
            return h('div', [
              h('Tooltip', {
                props: {
                  // theme:'light',
                  placement: 'top',
                  transfer: true
                }
              }, [
                texts,
                h('div', {
                  slot: 'content',
                  style: {
                    whiteSpace: 'normal',
                    wordBreak: 'break-all'
                  }
                }, params.row.orderMarkes)
              ])
            ])
          }
        },
        {
          title: '订单操作',
          align: 'center',
          width: 150,
          fixed: 'right',
          is_but: false,
          render: (h, params) => {
            if (params.row.carrier === '9C' && params.row.permission === true) {
              return h('div', [
                h('Button', {
                  props: {
                    type: 'error',
                    size: 'small'
                    // icon: 'md-battery-charging',
                  },
                  style: {
                    marginTop: '2px',
                    marginRight: '3px',
                    marginBottom: '2px'
                  },
                  on: {
                    click: () => {
                      this.relieve(params.row.id)
                    }
                  }
                }, '解锁'),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要重启支付吗！',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.repayFun(params.row.id)
                      },
                      'on-cancel': () => {
                        this.$Message.info('重启支付已取消')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginTop: '2px',
                        marginRight: '3px',
                        marginBottom: '2px'
                      }
                    }, '重付')
                  ])
                ]),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要重启订票吗！',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.replaceFun(params.row.id, false)
                      },
                      'on-cancel': () => {
                        this.$Message.info('重启订票已取消')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginTop: '2px',
                        marginBottom: '2px'
                      }
                    }, '重订')
                  ])
                ]),
                h('br'),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要强制回填吗！',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.constraint(params.row.id, params.row.orderNo)
                      },
                      'on-cancel': () => {
                        this.$Message.info('强制回填已取消')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginRight: '3px',
                        marginBottom: '2px'
                      }
                    }, '回填')
                  ])
                ]),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要出票吗！',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.issue(params.row.id)
                      },
                      'on-cancel': () => {
                        this.$Message.info('出票已取消')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginRight: '3px',
                        marginBottom: '2px'
                      }
                    }, '出票')
                  ])
                ]),
                h('span', [
                  h('Poptip', {
                    props: {
                      confirm: true,
                      transfer: true,
                      placement: 'left-start',
                      title: '确定要换号重订吗！',
                      type: 'error',
                      size: 'small',
                      width: '300',
                      vModel: true
                    },
                    on: {
                      'on-ok': () => {
                        this.replaceFun(params.row.id, true)
                      },
                      'on-cancel': () => {
                        this.$Message.info('换号重订已取消')
                      }
                    }
                  }, [
                    h('Button', {
                      props: {
                        type: 'primary',
                        size: 'small'
                      },
                      style: {
                        marginBottom: '2px'
                        // display: (params.row.permission === true ? false : params.row.carrier === '9C' ? true : false) ? "none" : "inline-block"
                      }
                    }, '换号')
                  ])
                ])
              ])
            }
          }
        }
      ],
      retreatData: [],

      loading: false,
      pageTotal: 0,
      pageNum: 1,
      pageSize: 20,

      searchFlag: false,
      choose: false,
      chooseObj: null,
      platformOrder: null,
      conditionsFlag: false

    }
  },
  mounted() {
    this.initRetreat()
  }
  ,
  methods: {
    initFormatter() {
      Date.prototype.Format = function (fmt) {
        let o = {
          'M+': this.getMonth() + 1,                 //月份
          'd+': this.getDate(),                    //日
          'h+': this.getHours(),                   //小时
          'm+': this.getMinutes(),                 //分
          's+': this.getSeconds(),                 //秒
          'q+': Math.floor((this.getMonth() + 3) / 3), //季度
          'S': this.getMilliseconds()             //毫秒
        }
        if (/(y+)/.test(fmt))
          fmt = fmt.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length))
        for (var k in o)
          if (new RegExp('(' + k + ')').test(fmt))
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)))
        return fmt
      }
    }
    ,
    //初始化
    initRetreat() {
      if (this.loading) return
      this.loading = true
      let postData = {
        'action': 'query',
        'page': this.pageNum,
        'islock': true
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        let _this = this
        if (response.data != null) {
          if (response.data.row !== false) {
            _this.retreatData = response.data.row
            _this.pageTotal = response.data.count
            _this.loading = false
          } else {
            _this.retreatData = []
            _this.loading = false
          }

        } else {
          this.$Message.error({
            content: '已锁单数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    }
    ,
    //分页切换
    handlePage(value) {
      this.pageNum = value
      this.initRetreat()
    }
    ,
    //条数切换
    handlePageSize(value) {
      this.pageSize = value
      this.initRetreat()
    }
    ,
    //订单号复制
    copyOrderNo(orderNo) {
      let oInput = document.createElement('input')
      oInput.value = orderNo
      document.body.appendChild(oInput)
      oInput.select()
      document.execCommand('Copy')
      document.body.removeChild(oInput)
      this.$Message.success('成功复制订单号')
    }
    ,
    //日志函数
    showOrderLog(orderId) {
      let postData = {
        'action': 'showLog',
        'orderid': orderId
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.$store.state.isoLogModal = true
            this.$store.state.isoLogData = response.data.row
          } else {
            this.$Message.info(response.data.msg)
          }
        } else {
          this.$Message.error({
            content: '日志数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    }
    ,
    //强制回填
    constraint(orderId, orderNo) {
      // alert(orderNo)
      let postData = {
        'action': 'reRetall',
        'orderid': orderId,
        'ticketNo': orderNo
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initRetreat()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 8
            })
          }
        } else {
          this.$Message.error({
            content: '强制回填数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    },
    //解锁
    relieve(orderId) {
      let postData = {
        'action': 'unLock',
        'orderid': orderId
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initRetreat()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '解锁数据异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    }
    ,
    //重启订票  换号 true or false
    replaceFun(orderId, exchange) {
      let postData = {
        'action': 'reOrder',
        'orderid': orderId,
        'changeAccount': exchange
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initRetreat()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '重启订票异常,请联系技术人员!',
            duration: 6
          })
        }

      })
    }
    ,
    //重启支付
    repayFun(orderId) {
      let postData = {
        'action': 'rePay',
        'orderid': orderId
      }
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initRetreat()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '重启支付异常,请联系技术人员!',
            duration: 6
          })
        }

      })
    }
    ,

    //换号重启
    changeReStart(orderId) {
      axios({
        url: '../ticket/manual.php?action=change_restart',
        method: 'post',
        data: {
          orderId
        }
      }).then(res => {
        if (!res.data) {
          window.location.reload(true)
        } else {
          alert('该单已经被其他人换号重启')
        }
      }).catch(error => console.log(error))
    }
    ,


    //回帖
    reTall(orderId, ticketNoVal, cashVal) {
      if ((ticketNoVal == null || cashVal == null) || (ticketNoVal == '' || cashVal == '')) {
        this.$Message.warning('请输入票号和金额')
        return
      }
      ticketNoVal = ticketNoVal.replace(/^\s+/, '')
      ticketNoVal = ticketNoVal.replace(/\s+$/, '')
      let postData = {
        'action': 'reTall',
        'orderid': orderId,
        'ticketNo': ticketNoVal,
        'cash': cashVal
      }
      // console.log('id:' + orderId, '票号:' + ticketNoVal, '金额:' + cashVal)
      this.$post('ticketIntl.php', postData).then((response) => {
        if (response.data != null) {
          if (response.data.success === true) {
            this.initRetreat()
            this.$Message.success(response.data.msg)
          } else {
            this.$Message.error({
              content: response.data.msg,
              duration: 3
            })
          }
        } else {
          this.$Message.error({
            content: '回帖异常,请联系技术人员!',
            duration: 6
          })
        }
      })
    }
    ,
    searchFlagFun() {
      this.searchFlag = !this.searchFlag
    }
    ,
    //条件筛选关闭函数（记忆搜索框功能）
    conditionsFun() {
      this.conditionsFlag = !this.conditionsFlag
    }
    ,

    //搜索框确认筛选函数（非记忆搜索功能）
    chooselock(obj, choose, page) {

      //当obj传入，意味搜索打开，obj是搜索的条件;且choose作为true传进来;
      let pagee = undefined
      if (obj) {
        this.chooseObj = JSON.parse(JSON.stringify(obj))
      }
      page ? pagee = page : pagee = 1
      //如果翻页，翻页函数会通过此判断翻页是否有搜索条件
      choose ? this.choose = true : this.choose = false
      obj.page = pagee
      obj.flag = true
      obj.action = 'query'
      obj.islock = true

      let postData = obj

      console.log(JSON.stringify(postData))

      if (this.loading) return
      this.loading = true

      this.$post('ticketIntl.php', postData).then((response) => {
        // if (response.data != null) {
          this.retreatData = response.data.row
        console.log('this.retreatData>',this.retreatData)
          this.pageTotal = response.data.count
          this.loading = false
        // } else {
        //   this.$Message.error({
        //     content: '搜索已锁单数据异常,请联系技术人员!',
        //     duration: 6
        //   })
        // }

      })
    }
    ,
    //条件筛选触发函数
    choosefun: function (choosear, pageNum) {
      let _this = this
      let pagee = ''
      if (pageNum) {
        pagee = pageNum
      } else {
        pagee = 1
      }
      // alert(JSON.stringify(choosear));
      if (_this.loading) return
      _this.loading = true

      // let postData = {
      //     "action": "showLog",
      //     "orderid": orderId
      // };
      // this.$post("ticketIntl.php", postData).then((response) => {
      //     this.ticketData = response.data.row;
      //     this.pageTotal = response.data.count;
      //     this.loading = false
      // });

      axios({
        url: 'bingo/ticking.php?action=choose',
        method: 'post',
        data: {
          choosear,
          flag: true,
          page: pagee
        }
      }).then((response) => {
        if (response.data != null) {
          _this.ticketData = response.data.row
          _this.pageTotal = response.data.count
          _this.loading = false
        } else {
          _this.$Message.error({
            content: '条件搜索已锁单数控异常!',
            duration: 6
          })
        }
      }).catch((error) => {
        console.log(error)
      })
    }
    ,

    //出票函数
    issue(id) {
      // this.$Message.error('未完:' + id)
      window.location.href = '../template/iso_info.html?id=' + id
    }
    ,
    //点击订单号，跳转到处理页面，但是只能看不能操作
    showOrderTwo(va) {
      window.location.href = '../template/iso_info.html?id=' + va + '&see=true'
    }
  }
}
//日志组件
const comLog = {
  template: '#isoLog',
  data() {
    return {
      isoLogColumns: [
        {
          title: '操作人',
          key: 'name',
          width: 100,
          align: 'center'
        },
        {
          title: '时间',
          key: 'time',
          width: 150,
          align: 'center',
          sortable: true
        },
        {
          title: '操作',
          key: 'note',
          align: 'center'
        }
      ]
    }
  },
  computed: {
    isoLogData: {
      get() {
        return this.$store.state.isoLogData
      },
      set() {

      }
    },
    LogModal: {
      get() {
        return this.$store.state.isoLogModal
      },
      set() {

      }
    }
  },
  methods: {
    closeLog() {
      this.$store.state.isoLogModal = false
      this.$store.state.isoLogData = null
    }
  }
}
const store = new Vuex.Store({
  state: {
    name: 'ticketName',
    isoLogModal: false,
    isoLogData: null
  },
  mutations: {}
})
new Vue({
  el: '#isoApp',
  store,
  components: {
    comTicket,
    comRetreat,
    comLog
  },
  data: {},
  computed: {
    name: {
      get() {
        return this.$store.state.name
      },
      set(data) {
        this.$store.state.name = data
      }
    }
  },
  methods: {
    tabChange(data) {
      console.log(data)
    }
  }
})
</script>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>留单规则管理_新</title>
    <link rel="stylesheet" href="../resource/iview4/dist/styles/iview.css">
    <link rel="stylesheet" href="../resource/css/tableCustom.css" >
    <link rel="stylesheet" href="//unpkg.com/view-design/dist/styles/iview.css">
    <!-- import iView -->

    <style rel="stylesheet">
        .retainTable{
            border: 1px silver solid;
        }
        .retainTable>thead>tr>th{
            border: 1px #E7E7E7 solid;
        }
        .retainTable>tbody>tr>td{
            border: 1px #E7E7E7 solid;
        }
        .inputBorder{
            border: 1px solid #DCDEE2;
            margin-left: 5px;
            margin-right: 5px;
            padding: 2px;
        }
        .inputBorder:focus{
            border: 1px solid #DCDEE2;
            outline: medium;
        }
    </style>
    <style>
        .rulerWindCss>div{
            width: 350px;
            margin-top: 3px;
        }
        .windowOperateClass{
            display: flex;
            justify-content:flex-end;
        }
        .levelClass{
            display: flex;
            flex-wrap: wrap;
            /*justify-content:space-around;*/
            justify-content:flex-start;
        }
    </style>
    <!--switch-->
    <style>
        input[type='checkbox'].switch{
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
            width: 30px;
            height: 15px;
            background: #ccc;
            border-radius: 10px;
            transition: border-color .3s, background-color .3s;
        }

        input[type='checkbox'].switch::after {
            content: '';
            display: inline-block;
            width: 13px;
            height:13px;
            border-radius: 50%;
            background: #fff;
            /*box-shadow: 0, 0, 2px, #999;*/
            transition:.4s;
            top: 1px;
            position: absolute;
            left: 2px;
        }

        input[type='checkbox'].switch:checked {
            background: #2D8CF0;
        }
        /* 当input[type=checkbox]被选中时：伪元素显示下面样式 位置发生变化 */
        input[type='checkbox'].switch:checked::after {
            content: '';
            position: absolute;
            left: 49%;
            /*top: 2px;*/
        }
    </style>
</head>
<body>

<div id="retainRulerManage">
    <div>
        <!--子 政策修改或新增弹窗-->
        <Modal
                width="400"
                v-model="alonewindowFlag"
                :styles="{top: '10px'}"
                scrollable
                title="修改新增弹窗"
                :footer-hide="true"
                :closable="true"
        >
            <div class="rulerWindCss">
                <!--名称-->
                <div>
                    <span slot="prepend">名称&nbsp;&nbsp;</span>
                    <i-select v-model="aloneRule.fieldName" style="width:120px">
                        <i-option v-for="(ele,index) in expressionObj.expressionArr"
                                  :value=ele.columnName
                                  :key=index>{{ele.columnComment}}</i-option>
                    </i-select>
                </div>
                <!--级别-->
                <div>
                    <span slot="prepend">级别&nbsp;&nbsp;</span>
                    <i-select v-model="aloneRule.level" style="width:200px">
                        <i-option  :value="0" key="0">简单</i-option>
                        <i-option  :value="1" key="1">高级</i-option>
                        <i-option  :value="2" key="2">排除日期专用</i-option>
                    </i-select>
                </div>
                <!--表达式-->
                <div v-show="aloneRule.level==1" class="levelClass">
                    <div>
                        <i-select v-model="expressionObj.expressionHead" style="width:120px">
                            <i-option v-for="(ele,index) in expressionObj.expressionArr"
                                      :value=ele.columnName
                                      :key=index>{{ele.columnComment}}</i-option>
                        </i-select>
                    </div>
                    <div>
                        <i-select v-model="expressionObj.expressionMiddle" style="width:100px">
                            <i-option  value="+" key="0">+</i-option>
                            <i-option  value="-" key="1">-</i-option>
                            <i-option  value="*" key="2">*</i-option>
                            <i-option  value="/" key="3">/</i-option>
                        </i-select>
                    </div>
                    <div>
                        <i-select v-model="expressionObj.expressionLater" style="width:120px">
                            <i-option v-for="(ele,index) in expressionObj.expressionArr"
                                      :value=ele.columnName
                                      :key=index>{{ele.columnComment}}</i-option>
                        </i-select>
                    </div>
                </div>
                <!--出发-->
                <div>
                    <i-input v-model="aloneRule.dptAirport">
                        <span slot="prepend">出发</span>
                    </i-input>
                </div>
                <!--到达-->
                <div>
                    <i-input v-model="aloneRule.arrAirport">
                        <span slot="prepend">到达</span>
                    </i-input>
                </div>
                <!--航班号-->
                <div>
                    <i-input v-model="aloneRule.flightCode">
                        <span slot="prepend">航班号</span>
                    </i-input>
                </div>
                <!--匹配日期-->
                <div>
                    <span slot="prepend">匹配日期&nbsp;&nbsp;</span>
                    <date-picker
                            v-model="aloneRule.date"
                            multiple
                            format="yyyy-MM-dd"
                            placement="bottom-end"
                            placeholder="可以多选"
                            @on-change="matchDateFun"
                            style="width: 220px"></date-picker>
                    <span>适用所有</span>
                    <input type="checkbox" v-model="aloneRule.allDateFlag">
                </div>
                <!--对比类型--><!--对比值--><!--排除日期-->
                <div :class="{levelClass:aloneRule.level!=2?true:false}">
                    <div>
                        <span slot="prepend">对比类型&nbsp;&nbsp;</span>
                        <i-select v-model="aloneRule.comparedType" style="width:120px">
                            <i-option  :value="0" key="0">等于</i-option>
                            <i-option  :value="1" key="1">不等于</i-option>
                            <i-option  :value="2" key="2">大于</i-option>
                            <i-option  :value="3" key="3">大于等于</i-option>
                            <i-option  :value="4" key="4">小于</i-option>
                            <i-option  :value="5" key="5">小于等于</i-option>
                            <i-option  :value="6" key="6">范围值包含自身</i-option>
                            <i-option  :value="7" key="7">不是范围值</i-option>
                            <i-option  :value="8" key="8">存在</i-option>
                            <i-option  :value="9" key="9">不存在</i-option>
                            <i-option  :value="10" key="10">左包含</i-option>
                            <i-option  :value="11" key="11">右包含</i-option>
                            <i-option  :value="12" key="12">在范围里</i-option>
                            <i-option  :value="13" key="13">不在范围里</i-option>
                        </i-select>
                    </div>
                    <div style="width: 150px" v-if="aloneRule.level ==1||aloneRule.level ==0">
                        <i-input v-model="aloneRule.value">
                            <span slot="prepend">对比值</span>
                        </i-input>
                    </div>
                    <div style="margin-top: 3px" v-else>
                        <span slot="prepend">排除日期&nbsp;&nbsp;</span>
                        <date-picker
                                v-model="aloneRule.notParseValu"
                                type="daterange" split-panels
                                format="yyyy-MM-dd"
                                placement="bottom-end"
                                @on-change="excludeDateFun"
                                style="width: 220px"></date-picker>
                    </div>
                </div>
                <!--规则代码-->
                <div>
                    <i-input v-model="aloneRule.ruleCode">
                        <span slot="prepend">规则代码</span>
                    </i-input>
                </div>
                <!--开始日期--> <!--天数-->
                <div class="levelClass">
                    <div style="width: 150px">
                        <i-input v-model="aloneRule.startDate">
                            <span slot="prepend">临近日期</span>
                        </i-input>
                    </div>
                    <div style="width: 150px">
                        <i-input v-model="aloneRule.days">
                            <span slot="prepend">远期</span>
                        </i-input>
                    </div>
                </div>
                <!--日期类型-->
                <div>
                    <span slot="prepend">日期类型&nbsp;&nbsp;</span>
                    <i-select v-model="aloneRule.dateType" style="width:200px">
                        <i-option  :value="1" key="1">有效日期</i-option>
                        <i-option  :value="0" key="0">固定日期</i-option>
                    </i-select>
                </div>
                <!--留钱-->
                <div>
                    <i-input v-model="aloneRule.keepMoney">
                        <span slot="prepend">留钱&nbsp;&nbsp;</span>
                    </i-input>
                </div>
                <!--对比对象-->
                <div>
                    <span slot="prepend">对比对象&nbsp;&nbsp;</span>
                    <i-select v-model="aloneRule.comparedObj" style="width:200px">
                        <i-option  :value="0" key="0">本身</i-option>
                        <i-option  :value="1" key="1">最小</i-option>
                        <i-option  :value="2" key="2">平均</i-option>
                        <i-option  :value="3" key="3">最大</i-option>
                    </i-select>
                </div>
                <!--排序等级-->
                <div>
                    <i-input v-model="aloneRule.priority">
                        <span slot="prepend">权重修改</span>
                    </i-input>
                </div>
                <!--备注-->
                <div>
                    <i-input v-model="aloneRule.remark" type="textarea"/>
                </div>
                <!--操作按钮-->
                <div class="windowOperateClass">
                    <i-button size="small" @click="rulerCancelWindowFun">取消</i-button>
                    <i-button  size="small" @click="rulerChangeFun">确定</i-button>
                </div>
            </div>
        </Modal>
        <!--组修改或新增弹窗-->
        <Modal
                width="400"
                v-model="groupObj.groupEditFlag"
                :styles="{top: '10px'}"
                scrollable
                title="组修改新增弹窗"
                :footer-hide="true"
                :closable="true"
        >
            <div class="rulerWindCss">
                <!--类型-->
                <div>
                    <span slot="prepend">类型&nbsp;&nbsp;</span>
                    <i-select v-model="groupObj.aloneGroupObj.type" style="width:120px">
                        <i-option :value=0>单个满足</i-option>
                        <i-option :value=1>多个全部满足</i-option>
                        <i-option :value=2>多个满足其中一个</i-option>
                    </i-select>
                </div>
                <!--权重-->
                <div>
                    <i-input v-model="groupObj.aloneGroupObj.priority">
                        <span slot="prepend">权重</span>
                    </i-input>
                </div>
                <!--是否留单-->
                <div>
                    <span slot="prepend">是否留单</span>
                    <i-select v-model="groupObj.aloneGroupObj.whether" style="width:120px">
                        <i-option :value=0>不留单</i-option>
                        <i-option :value=1>留单</i-option>
                    </i-select>
                </div>
                <!--操作按钮-->
                <div class="windowOperateClass">
                    <i-button size="small" @click="groupCancelWindowFun">取消</i-button>
                    <i-button  size="small" @click="groupSureFun">确定</i-button>
                </div>
            </div>
        </Modal>
        <!--table-->
        <div>
            <i-button size="small" size="small" @click="groupEditFlagFun(null)">新增组</i-button>
            <i-table
                    row-key="headId"
                    :columns="tableHead"
                    :context-menu="true"
                    :data="rulerObj" border></i-table>
        </div>
    </div>
</div>

<script src="../vue/vue.js"></script>
<script src="../resource/iview4/dist/iview.js"></script>
<!--<script src="//unpkg.com/view-design/dist/iview.min.js"></script>-->
<script src="../vue/axios.min.js"></script>
<script src="../vue/vuex.js"></script>
<script type="text/javascript">

    //~~~!!!~~~ 注意： 排除日期和对比值传给后台都是叫value，但是前端因为
    //date和input输入格式不同，前端做了转换，详细请看 excludeDateFun，changeOrder，rulerChangeFun三个方法
    new Vue({
        el:'#retainRulerManage',
        data(){
            return{
                //table head
                tableHead : [
                    {
                        title: '序号',
                        key: 'xuhao',
                        tree: true,
                        width:'100'
                    },
                    {
                        title: '权重',
                        key: 'priority',
                        width:'100'
                    },
                    {
                        title: '类型',
                        key: 'type',
                        width:'100',
                        render:(h, params) => {
                            let text = '';
                            if(params.row.type==0){
                                text = '单个满足';
                            }else if(params.row.type==1){
                                text = '多个全部满足';
                            }else if(params.row.type==2){
                                text = '多个满足其中一个';
                            }
                            return h('span',text)
                        }
                    },
                    {
                        title: '留单',
                        key: 'whether',
                        width:'100',
                        render:(h, params) => {
                            let text = '';
                            if(params.row.whether==0){
                                text = '否';
                            }else if(params.row.whether==1){
                                text = '是';
                            }
                            return h('span',text)
                        }
                    },
                    {
                        title: '最后更新时间',
                        key: 'lastUpdateTime',
                        width:'200'
                    },
                    {
                        title: '备注',
                        key: 'remark',
                    },
                    {
                        title: '状态',
                        key: 'state',
                        width:'70',
                        render: (h, params) => {
                            if(!params.row.children){
                                return h('div', [
                                    h('input',{
                                        class:{
                                            switch:true,
                                        },
                                        domProps:{
                                            type:'checkbox',
                                            checked:!!params.row.state,
                                        },
                                        on: {
                                            input: function (event) {
                                                params.row.state = event.target.checked;
                                                let flag = event.target.checked;
                                                if(flag){
                                                    flag = 1;
                                                }else{
                                                    flag = 0;
                                                }
                                                params.row.state = flag;
                                                axios({
                                                    url:'http://120.24.148.171:31657/edit',
                                                    method:"post",
                                                    data:params.row
                                                }).then(res=>{
                                                    if(res.data.code == 200){
                                                        this.$Message.info({
                                                            content:res.data.message,
                                                            closable:true,
                                                            duration:3,
                                                        });
                                                    }else{
                                                        this.$Message.error({
                                                            content:res.data.message,
                                                            closable:true,
                                                            duration:10,
                                                        });
                                                    }
                                                }).catch(err=>{
                                                    console.log(err)
                                                })
                                            }
                                        }
                                    }),
                                ]);
                            }
                        }
                    },
                    {
                        title: '操作',
                        key: 'setting',
                        render: (h, params) => {
                            let par = params;
                            let that = this;
                            if(params.row.children){
                                return h('div', [
                                    //修改
                                    h('i-button', {
                                        domProps:{
                                            innerHTML:'组修改'
                                        },
                                        props:{
                                            // type:'error',
                                            size:'small'
                                        },
                                        on:{
                                            //组修改
                                            click:(params)=>{
                                                that.groupEditFlagFun(par.row)
                                            }
                                        }
                                    }),
                                    //删除
                                    h('i-button', {
                                        domProps:{
                                            innerHTML:'组删除'
                                        },
                                        props:{
                                            type:'error',
                                            size:'small'
                                        },
                                        style:{
                                            marginLeft:'4px'
                                        },
                                        on:{
                                            click:(params)=>{
                                                //组删除
                                                that.groupDelet(par.row.id)
                                            }
                                        }
                                    }),
                                    //新增
                                    h('i-button', {
                                        domProps:{
                                            innerHTML:'新增'
                                        },
                                        props:{
                                            type:'primary',
                                            size:'small'
                                        },
                                        style:{
                                            marginLeft:'4px'
                                        },
                                        on:{
                                            click:()=>{
                                                that.changeOrder(null,par.row.id)
                                            }
                                        }
                                    }),
                                ]);
                            }else{
                                return h('div', [
                                    //修改
                                    h('i-button', {
                                        domProps:{
                                            innerHTML:'修改'
                                        },
                                        props:{
                                            size:'small'
                                        },
                                        on:{
                                            click:(params)=>{
                                                that.changeOrder(par.row)
                                            }
                                        }
                                    }),
                                    //删除
                                    h('i-button', {
                                        domProps:{
                                            innerHTML:'删除'
                                        },
                                        props:{
                                            type:'error',
                                            size:'small'
                                        },
                                        style:{
                                            marginLeft:'4px'
                                        },
                                        on:{
                                            click:(params)=>{
                                                that.alotDelet(par.row.id,1)
                                            }
                                        }
                                    }),
                                ]);
                            }
                        }
                    },
                ],
                //规则对象载体
                rulerObj:[],
                //单独的政策弹窗
                alonewindowFlag:false,
                //修改与新增的规则载体
                aloneRule:{
                    //到达机场
                    arrAirport: "*",
                    //比较规则 0本身，1最小，2平均，3最大。
                    comparedObj: 0,
                    //比较类型 0等于，1不等于，2大于，3大于等于，4小于，5小于等于，6中间范围包含自身，7不是中间范围值
                    //8 存在即可，9 不存在，10 左包含，11右包含，12 在范围里，13不在范围里，
                    comparedType: 0,
                    //创建时间
                    createTime: "",
                    //匹配日期 "2020-07-09,2020-07-02"   "*"统一匹配
                    date: "*",
                    //日期类型 1 有效日期，0固定日期
                    dateType: 0,
                    //天数
                    days: 0,
                    //出发机场
                    dptAirport: "",
                    //表达式 +-*/
                    expression: "",
                    // 航班号
                    flightCode: "",
                    //~~~~
                    groupId: 0,
                    id: '',
                    //最后更新时间
                    lastUpdateTime: "",
                    //级别 0 简单，1高级,2排除日期高级专用。
                    level: 0,
                    //渲染名称
                    // name: "",
                    //排序等级
                    priority: 0,
                    //备注说明
                    remark: "",
                    //规则代码
                    ruleCode: "",
                    //开始日期
                    startDate: "",
                    //是否启用
                    state: 0,
                    //排除日期值
                    value: "",
                    //排除日期解析前，渲染值
                    notParseValu:[],
                    //排除日期解析后，发送给后台的值
                    parseValue:'',
                    //留钱
                    keepMoney:'',
                    //前端自用规则载体 日期是否全部 默认为false
                    allDateFlag:true,
                },
                //修改与新增判断开关
                addAndChangeFlag:undefined,
                //新增时候需要用到的组id
                addAndChangeGourpId:undefined,
                //高级功能 表达式
                expressionObj:{
                    expressionHead:'',
                    expressionMiddle:'',
                    expressionLater:'',
                    //ajax动态获取name值
                    expressionArr:[],
                },
                //组对象
                groupObj:{
                    //组编辑弹窗开关（新增或修改）
                    groupEditFlag:false,
                    //新增禁止使用 switch中的 单个满足
                    aloneGroupObjNew:true,
                    aloneGroupObj:{
                        //    单个满足
                        type:1,
                        prioriy:undefined,
                        whether:0,
                    },
                },

            }
        },
        methods:{
            // 初始化函数
            objDataFun(){
                axios({
                    url:'http://120.24.148.171:31657/list',
                    method:"get",
                }).then(res=>{
                    if(res.data.code == 200){
                        for (let j = 0; j < res.data.data.paramGroups.length; j++) {
                            //前端手动定义一个id，让业务操作更方便
                            let headId =  'fu' + res.data.data.paramGroups[j].id;
                            res.data.data.paramGroups[j].children = [];
                            //前端手动定义一个序号，让业务员更方便查看数据
                            let xuhao = j+1;
                            res.data.data.paramGroups[j].headId = headId;
                            res.data.data.paramGroups[j].xuhao = xuhao;

                            for (let i = 0; i < res.data.data.parameters.length; i++) {

                                //res.data.data.parameters[i].startDate 格式只会是 THATDAT 或 THATDAT + 数字
                                //THATDAT需要转成0。 同时还要解析是否有正负符号  +号不展示，-号展示
                                let start,startSymbol;
                                if(res.data.data.parameters[i].startDate.search(/[0-9]+/)!=-1){
                                    start = res.data.data.parameters[i].startDate.match(/[0-9]+/)[0];
                                }else{
                                    start = 0;
                                }
                                if(res.data.data.parameters[i].startDate.search(/\-/)!=-1){
                                    startSymbol = res.data.data.parameters[i].startDate.match(/\-/)[0];
                                }else{
                                    startSymbol = '';
                                }
                                res.data.data.parameters[i].startDate = startSymbol + start;
                                //
                                //iview 的 switch 必须用boolean 后端传的是 0,1；
                                if(res.data.data.parameters[i].state){
                                    res.data.data.parameters[i].state = true;
                                }else{
                                    res.data.data.parameters[i].state = false;
                                };
                                //让子规则对应到各自的父的下面 方便table 做树状图展示
                                if(res.data.data.paramGroups[j].id == res.data.data.parameters[i].groupId){
                                    res.data.data.paramGroups[j].children.push(res.data.data.parameters[i]);
                                    let headId = 'zi' + res.data.data.parameters[i].id;
                                    let xuhao = i+1;
                                    res.data.data.parameters[i].headId = headId;
                                    res.data.data.parameters[i].xuhao = xuhao;
                                    //把组的是否留单数据赋值给子
                                    res.data.data.parameters[i].whether = res.data.data.paramGroups[j].whether;
                                    continue
                                };

                            }
                        }
                        this.rulerObj = res.data.data.paramGroups;
                    }else{
                        this.$Message.error({
                            content:res.data.message,
                            closable:true,
                            duration:10,
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //批量删除按钮
            alotDelet(id,type){
                //type 1 为单独删除。 暂时只有单独删除
                axios({
                    url:'http://120.24.148.171:31657/del',
                    method:"post",
                    data:{id,}
                }).then(res=>{
                    if(res.data.code == 200){
                        this.$Message.info({
                            content:res.data.message,
                            closable:true,
                            duration:3,
                        });
                        this.objDataFun()
                    }else{
                        alert('操作失败');
                    }
                }).catch(err=>{
                    console.log(err)
                })

            },
            // 新增和修改的函数按钮
            // 新增 data groupId 都不会传
            changeOrder(data,groupId){
                axios({
                    url:'http://120.24.148.171:31657/header?carrier=AQ',
                    method:'get',
                }).then(res=>{
                    if(res.data.code == 200){
                        this.expressionObj.expressionArr = res.data.data;
                        if(data){
                            if(data.expression){
                                if(data.expression.match(/\+|\-|\*|\//)){
                                    let a = (data.expression.match(/\+|\-|\*|\//))[0];
                                    let b = data.expression.split(/\+|\-|\*|\//);
                                    this.expressionObj.expressionHead = b[0];
                                    this.expressionObj.expressionLater = b[1];
                                    this.expressionObj.expressionMiddle = a;
                                }
                            }
                        }
                        this.alonewindowFlag = !this.alonewindowFlag;
                    }else{
                        alert(res.data.message)
                    }
                }).catch(err=>{
                    console.log(err)
                })
                //当data存在 则是 修改和查看 否则是新增
                if(data){
                    //如果默认数据中匹配日期是*，则代表开启全选
                    if(data.date === '*'){
                        data.allDateFlag = true;
                    }
                    //当时排除日期的时候
                    if(data.level==2){
                        let a = [];
                        a = data.value.split(';');
                        data.notParseValu = [a[0],a[a.length-1]];
                    }

                    this.aloneRule = Object.assign(this.aloneRule,JSON.parse(JSON.stringify(data)));
                    this.addAndChangeFlag = data;
                    this.addAndChangeGourpId = data.groupId;
                }else{
                    //新增没有id 该值在点击确定按钮时是否使用data中的id
                    this.addAndChangeFlag = undefined;
                    this.addAndChangeGourpId = groupId;
                }
            },
            //组弹窗取消按钮
            groupCancelWindowFun(){
                this.groupObj.groupEditFlag = false;
            },
            //删除组
            groupDelet(data){
                axios({
                    url:'http://120.24.148.171:31657/group/del/'+data,
                    method:"get",
                }).then(res=>{
                    if(res.data.code == 200){
                        this.$Message.info({
                            content:'成功',
                            closable:true,
                            duration:3,
                        });
                        this.objDataFun()
                    }else{
                        this.$Message.error({
                            content:res.data.message,
                            closable:true,
                            duration:10,
                        })
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //组修改新增展示弹窗方法
            groupEditFlagFun(data){
                this.groupObj.groupEditFlag = true;
                //data存在 则是修改 赋值给aloneGroupObjNew 方便ajax 传值
                if(data){
                    if(!data.hasOwnProperty('whether')){
                        data.whether = 0
                    }
                    this.groupObj.aloneGroupObj = data;
                    this.groupObj.aloneGroupObjNew = false;
                }
                else{
                    // this.groupObj.aloneGroupObj = {
                    //     type:1,
                    //     prioriy:undefined,
                    //
                    // };
                    this.groupObj.aloneGroupObjNew = true;
                }
            },
            //组 弹窗确认添加方法
            groupSureFun(){
                //修改
                if(!this.groupObj.aloneGroupObjNew){
                    axios({
                        url:'http://120.24.148.171:31657/group/edit',
                        method:"post",
                        data:this.groupObj.aloneGroupObj
                    }).then(res=>{
                        if(res.data.code == 200){
                            this.$Message.info({
                                content:'成功',
                                closable:true,
                                duration:3,
                            });
                            this.groupObj.groupEditFlag = false;
                            this.objDataFun()
                        }else{
                            this.$Message.error({
                                content:res.data.message,
                                closable:true,
                                duration:10,
                            })
                        }
                    }).catch(err=>{
                        console.log(err)
                    })
                }
                //新增
                else{
                    this.groupObj.aloneGroupObj.id = new Date().getTime();
                    axios({
                        url:'http://120.24.148.171:31657/group/save ',
                        method:"post",
                        data:this.groupObj.aloneGroupObj
                    }).then(res=>{
                        if(res.data.code == 200){
                            this.$Message.info({
                                content:'成功',
                                closable:true,
                                duration:3,
                            });
                            this.groupObj.groupEditFlag = false;
                            this.objDataFun()
                        }else{
                            this.$Message.error({
                                content:res.data.message,
                                closable:true,
                                duration:10,
                            })
                        }
                    }).catch(err=>{
                        console.log(err)
                    })
                }
            },
            //政策新增规则或修改规则
            rulerChangeFun(){
                let url = 'http://120.24.148.171:31657/edit';
                //如果为false,则是新增
                if(!this.addAndChangeFlag){
                    delete this.aloneRule.id;
                    url = 'http://120.24.148.171:31657/save';
                }
                function parssDate(time1){

                    let year = new Date(time1).getFullYear();
                    let month = (new Date(time1).getMonth())+1;
                    let day = new Date(time1).getDate();
                    let hour = new Date(time1).getHours();
                    let minutes = new Date(time1).getMinutes();
                    let seconds = new Date(time1).getSeconds();
                    if(month<10){
                        month = '0'+month;
                    }
                    if(day<10){
                        day = '0'+day;
                    }
                    if(!hour){
                        hour = '00';
                    }else if(hour<10){
                        hour = '0'+ hour;
                    }
                    if(!minutes){
                        minutes = '00';
                    }
                    if(!seconds){
                        seconds = '00';
                    }
                    // let parseTime = year +"-"+ month +"-"+ day +' '+hour+':'+minutes +':'+seconds;
                    let parseTime = year +"-"+ month +"-"+ day;

                    return parseTime
                };

                this.aloneRule.startDate *= 1;
                if(this.aloneRule.startDate>this.aloneRule.days||this.aloneRule.startDate<0){
                    alert('临近日期必须小于远期日期且不能为负数');
                    return
                }
                if(this.aloneRule.allDateFlag){
                    this.$set(this.aloneRule,'date','*');
                }else{
                    let date = '';
                    for (let i = 0; i < this.aloneRule.date.length; i++) {
                        if(i==this.aloneRule.date.length-1){
                            date += parssDate(this.aloneRule.date[i])
                        }else{
                            date += parssDate(this.aloneRule.date[i]) +';'
                        }
                    }
                    this.$set(this.aloneRule,'date',date);
                }
                this.aloneRule.expression = this.expressionObj.expressionHead + this.expressionObj.expressionMiddle + this.expressionObj.expressionLater;
                for (let i = 0; i < this.expressionObj.expressionArr.length; i++) {
                    if(this.aloneRule.fieldName == this.expressionObj.expressionArr[i].columnName){
                        this.$set(this.aloneRule,'name',this.expressionObj.expressionArr[i].columnComment)
                        this.$set(this.aloneRule,'fieldType',this.expressionObj.expressionArr[i].dataType)
                        break
                    }
                }
                if(this.aloneRule.state){
                    this.aloneRule.state = 1
                }else{
                    this.aloneRule.state = 0
                }
                //此处赋值组id
                this.aloneRule.groupId = this.addAndChangeGourpId;
                //将解析好的排除日期赋值给value 当级别为高级排除日期的时候
                if(this.aloneRule.level==2){
                    this.aloneRule.value = this.aloneRule.parseValue;
                    this.aloneRule.parseValue = undefined;
                }
                let data = JSON.parse(JSON.stringify(this.aloneRule))
                axios({
                    url,
                    method:"post",
                    data,
                }).then(res=>{
                    if(res.data.code == 200){
                        this.$Message.info({
                            content:res.data.message,
                            closable:true,
                            duration:3,
                        });
                        this.objDataFun();
                        this.alonewindowFlag = false;
                        this.addAndChangeGourpId = undefined;
                    }else{
                        this.$Message.error({
                            content:res.data.message,
                            closable:true,
                            duration:10,
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //单独政策弹窗关闭方法
            rulerCancelWindowFun(){
                this.alonewindowFlag = false
            },
            //匹配日期格式修改方法
            matchDateFun(){
                this.aloneRule.allDateFlag = false;
            },
            //排除日期格式修改方法
            excludeDateFun(data){
                let date1 =  data[0];
                let date2 = data[1];
                let date_s = new Date(date2) - new Date(date1);
                //包含初始日期
                date_s = date_s/(1000*60*60*24)+1;
                let value = date1+';';
                date1 =  new Date(data[0]);
                for (let i = 1; i <date_s; i++) {
                    let dateParse = new Date(date1+'');
                    //下面代码为解析日期格式
                    //需要排除这种形式 2020-08-01;2020-08-02;2020-08-03; 分号结束，日期为单数的加0
                    if(i == (date_s-1)){
                        let a = dateParse.setDate(dateParse.getDate()+i);
                        a = (new Date(a).toLocaleDateString());
                        let parseValue1 = a.split('/');
                        for (let j = 1; j < parseValue1.length; j++) {
                            if(parseValue1[j]*1<10){
                                parseValue1[j] = '0'+parseValue1[j];
                            }
                        }
                        value += parseValue1[0]+'-'+parseValue1[1]+'-'+parseValue1[2]+';';
                        break
                    }else{
                        let a = dateParse.setDate(dateParse.getDate()+i);
                        a = (new Date(a).toLocaleDateString());
                        let parseValue1 = a.split('/');
                        for (let j = 1; j < parseValue1.length; j++) {
                            if(parseValue1[j]*1<10){
                                parseValue1[j] = '0'+parseValue1[j];
                            }
                        }
                        value += parseValue1[0]+'-'+parseValue1[1]+'-'+parseValue1[2]+';'
                    }
                }
                value = value.replace(/\//g,'-');

                //~~~!!!~~~ 注意： notParseValu用来在日期框中展示，是一个数组
                //~~~!!!~~~ 注意： parseValue用来在发送给后台，是一个字符串
                //因为后台接收名叫value。弹窗中的级别选项中，简单和高级的对比值，排除日期专用的排除日期值
                //后台都是用value接收，但是前端因为date输入框和input输入框格式不同，所以前端自己这里做了转换
                this.aloneRule.parseValue = value;
            },
            //修改排序
            changeOrderFun(order){
                let va = event.target.value;
                order.priority = va;
                axios({
                    url:'http://120.24.148.171:31657/edit',
                    method:"post",
                    data:order
                }).then(res=>{
                    if(res.data.code == 200){
                        this.$Message.info({
                            content:res.data.message,
                            closable:true,
                            duration:3,
                        });
                        this.objDataFun()
                    }else{
                        this.$Message.error({
                            content:res.data.message,
                            closable:true,
                            duration:10,
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },
            //修改是否启用的switch
           /* acitveFun(flag){
                if(flag){
                    flag = 1;
                }else{
                    flag = 0;
                }
                let data = null;
                let id = event.target.dataset.id;
                let leng = this.rulerObj.length;
                for (let i = 0; i < leng; i++) {
                    if(this.rulerObj[i].id == id){
                        data = JSON.parse(JSON.stringify(this.rulerObj[i]));
                    }
                }
                data.state = flag;
                axios({
                    url:'http://120.24.148.171:31657/edit',
                    method:"post",
                    data:data
                }).then(res=>{
                    if(res.data.code == 200){
                        this.$Message.info({
                            content:res.data.message,
                            closable:true,
                            duration:3,
                        });
                    }else{
                        this.$Message.error({
                            content:res.data.message,
                            closable:true,
                            duration:3,
                        });
                    }
                }).catch(err=>{
                    console.log(err)
                })
            },*/
        },
        created(){
            this.objDataFun()
        }
    })

</script>

</body>
</html>